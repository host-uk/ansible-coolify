# Systemd-enabled Ubuntu container for Coolify development
# This Dockerfile creates a container that behaves like a real server
FROM {{ docker_dev_base_image }}

ENV DEBIAN_FRONTEND=noninteractive
ENV container=docker

# Install systemd and required packages
RUN apt-get update && apt-get install -y \
    systemd \
    systemd-sysv \
    openssh-server \
    sudo \
    curl \
    wget \
    ca-certificates \
    gnupg \
    lsb-release \
    python3 \
    python3-apt \
    ufw \
    fail2ban \
    iproute2 \
    iputils-ping \
    net-tools \
    vim \
    git \
    jq \
    && rm -rf /var/lib/apt/lists/*

# Configure SSH - Ubuntu 24.04 uses ssh.socket for socket activation
RUN mkdir -p /var/run/sshd && \
    mkdir -p /root/.ssh && \
    chmod 700 /root/.ssh && \
    sed -i 's/#PermitRootLogin.*/PermitRootLogin prohibit-password/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config && \
    sed -i 's/#PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config

# Install Docker
RUN curl -fsSL https://get.docker.com | sh

# Configure Docker for nested container operation (DIND)
# Use vfs storage driver since overlayfs doesn't work nested
# We use a systemd override to pass --storage-driver=vfs directly to dockerd
# This is robust: even if Coolify's install script modifies daemon.json, vfs is enforced via CLI flag
# Note: daemon.json must NOT contain storage-driver when using the flag (Docker forbids duplicates)
RUN mkdir -p /etc/docker /etc/systemd/system/docker.service.d && \
    echo '{}' > /etc/docker/daemon.json && \
    printf '[Service]\nExecStart=\nExecStart=/usr/bin/dockerd --storage-driver=vfs -H fd:// --containerd=/run/containerd/containerd.sock\n' \
    > /etc/systemd/system/docker.service.d/vfs-storage.conf

# Clean up systemd units that don't work in containers (but preserve SSH and Docker)
RUN cd /lib/systemd/system/sysinit.target.wants/ && \
    ls | grep -v systemd-tmpfiles-setup | xargs rm -f 2>/dev/null || true && \
    rm -f /lib/systemd/system/local-fs.target.wants/* && \
    rm -f /lib/systemd/system/sockets.target.wants/*udev* && \
    rm -f /lib/systemd/system/sockets.target.wants/*initctl* && \
    rm -f /lib/systemd/system/anaconda.target.wants/* && \
    rm -f /lib/systemd/system/plymouth* && \
    rm -f /lib/systemd/system/systemd-update-utmp*

# Enable SSH socket and Docker after cleanup
RUN systemctl enable ssh.socket && \
    systemctl enable docker

# Create directory for logs
RUN mkdir -p /var/log/coolify

# Volume for cgroup
VOLUME ["/sys/fs/cgroup"]

# Expose SSH and Coolify-related ports
EXPOSE 22 80 443 6001 6002 8000

# Use systemd as init
STOPSIGNAL SIGRTMIN+3
CMD ["/lib/systemd/systemd"]
