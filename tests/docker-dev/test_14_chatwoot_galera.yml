---
# Test 14: Chatwoot with Galera Cluster
# Tests: Deploy a Coolify one-click service (Chatwoot) connected to Galera multi-master database
# This pattern applies to 200+ Coolify one-click services
#
# Uses multi-play structure:
# 1. localhost: Create Docker containers via docker_dev role
# 2. test-controller.lan: Install Coolify via coolify role
# 3. localhost: Run Chatwoot + Galera integration tests

# =============================================================================
# PLAY 1: Create Docker Development Environment
# =============================================================================
- name: "Test 14: Setup Docker Environment"
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - conftest.yml
  vars:
    docker_dev_name_prefix: "{{ test_docker_dev_name_prefix }}"
    docker_dev_network_name: "{{ test_docker_dev_network_name }}"
    docker_dev_network_subnet: "{{ test_docker_dev_network_subnet }}"
    docker_dev_network_gateway: "{{ test_docker_dev_network_gateway }}"
    docker_dev_compose_path: "{{ test_docker_dev_compose_path }}"
    docker_dev_logs_path: "{{ test_docker_dev_logs_path }}"
    docker_dev_containers: "{{ test_docker_dev_containers_full }}"
    docker_dev_ssh_keys_path: "{{ test_docker_dev_ssh_keys_path }}"

  tasks:
    - name: "SETUP: Display test info"
      ansible.builtin.debug:
        msg: |
          ====================================================================
                    TEST 14: CHATWOOT WITH GALERA CLUSTER
          ====================================================================
            Phase 1: Creating Docker development environment
            - Using docker_dev role for container management
            - Using coolify role for Coolify installation
            - Testing Chatwoot + Galera integration
          ====================================================================

    - name: "SETUP: Check if compose file exists"
      ansible.builtin.stat:
        path: "{{ docker_dev_compose_path }}/docker-compose.yml"
      register: compose_file

    - name: "SETUP: Stop existing containers"
      community.docker.docker_compose_v2:
        project_src: "{{ docker_dev_compose_path }}"
        state: absent
        remove_volumes: true
      when: compose_file.stat.exists
      ignore_errors: true

    - name: "SETUP: Remove existing directories"
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ docker_dev_compose_path }}"
        - "{{ docker_dev_logs_path }}"
      ignore_errors: true

    - name: "SETUP: Create containers via docker_dev role"
      ansible.builtin.include_role:
        name: docker_dev

  tags:
    - test
    - chatwoot
    - galera
    - setup

# =============================================================================
# PLAY 2: Install Coolify via Role
# =============================================================================
- name: "Test 14: Install Coolify via Role"
  hosts: test-controller.lan
  gather_facts: true
  vars_files:
    - conftest.yml
  vars:
    # Coolify role configuration for testing
    coolify_root_username: "admin"
    coolify_root_user_email: "admin@test.local"
    coolify_root_user_password: "TestPassword123!"
    coolify_auto_setup_enabled: true
    coolify_api_base_url: "http://localhost:8000/api/v1"
    coolify_state_path: "./state"
    coolify_docker_address_pool_base: "172.30.0.0/16"
    coolify_docker_address_pool_size: "24"
    coolify_docker_pool_force_override: false
    coolify_autoupdate: false
    coolify_registry_url: "https://hub.docker.com"
    coolify_identity_key_actual_path: "/data/coolify/ssh/keys/id.root@host.docker.internal"
    coolify_detected_key_uuid: ""

  tasks:
    - name: "COOLIFY: Install and configure via coolify role"
      ansible.builtin.include_role:
        name: coolify

    - name: "COOLIFY: Store API token for later plays"
      ansible.builtin.set_fact:
        controller_api_token: "{{ coolify_api_token }}"
        controller_api_ready: "{{ coolify_api_ready }}"
      delegate_to: localhost
      delegate_facts: true

  tags:
    - test
    - chatwoot
    - galera
    - coolify-setup

# =============================================================================
# PLAY 3: Run Chatwoot + Galera Integration Tests
# =============================================================================
- name: "Test 14: Chatwoot with Galera Cluster Integration Tests"
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - conftest.yml
  vars:
    docker_dev_name_prefix: "{{ test_docker_dev_name_prefix }}"
    docker_dev_compose_path: "{{ test_docker_dev_compose_path }}"
    docker_dev_logs_path: "{{ test_docker_dev_logs_path }}"
    controller_ip: "172.29.0.10"
    coolify_api_url: "http://{{ controller_ip }}:8000/api/v1"
    coolify_api_token: "{{ controller_api_token }}"

    # Galera configuration for test
    galera_hostname: "db.local"
    galera_root_password: "galera_root_pass_123"
    galera_app_database: "chatwoot_production"
    galera_app_user: "chatwoot"
    galera_app_password: "chatwoot_pass_456"

    # Chatwoot configuration
    chatwoot_service_name: "chatwoot-test"
    chatwoot_secret_key: "test_secret_key_base_1234567890abcdef"

    # Project/Environment
    test_project_name: "chatwoot-galera-test"

  tasks:
    - name: "TEST: Verify API is ready"
      ansible.builtin.assert:
        that:
          - controller_api_ready | default(false)
          - controller_api_token | default('') | length > 0
        fail_msg: "Coolify API not ready or token not set"
        success_msg: "Coolify API ready, token configured via role"

    - name: "TEST: Verify API access"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/version"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: api_check
      retries: 10
      delay: 3
      until: api_check.status == 200

    # ==========================================================================
    # PHASE 1: Deploy Galera Cluster (Simplified for Test)
    # ==========================================================================
    - name: "GALERA-001: Create test project"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/projects"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "{{ test_project_name }}"
          description: "Chatwoot + Galera integration test"
        status_code: [200, 201]
      register: project_create

    - name: "GALERA-001: Store project UUID"
      ansible.builtin.set_fact:
        project_uuid: "{{ project_create.json.uuid }}"

    - name: "GALERA-001: Get project details"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/projects/{{ project_uuid }}"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: project_detail

    - name: "GALERA-001: Store environment info"
      ansible.builtin.set_fact:
        environment_uuid: "{{ project_detail.json.environments[0].uuid }}"
        environment_name: "{{ project_detail.json.environments[0].name }}"

    # Register a worker server via API (instead of using localhost which needs special handling)
    - name: "GALERA-001: Generate SSH key for server registration"
      community.docker.docker_container_exec:
        container: "{{ docker_dev_name_prefix }}-controller"
        command: ssh-keygen -t rsa -b 4096 -f /tmp/test-key -N "" -C "chatwoot-galera-test"
      changed_when: true

    - name: "GALERA-001: Read SSH keys"
      community.docker.docker_container_exec:
        container: "{{ docker_dev_name_prefix }}-controller"
        command: cat /tmp/test-key{{ item }}
      register: ssh_keys
      loop: ["", ".pub"]
      changed_when: false

    - name: "GALERA-001: Set key facts"
      ansible.builtin.set_fact:
        test_private_key: "{{ ssh_keys.results[0].stdout }}"
        test_public_key: "{{ ssh_keys.results[1].stdout }}"

    - name: "GALERA-001: Register private key in Coolify"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/security/keys"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "chatwoot-galera-test-key"
          description: "Key for Chatwoot Galera test"
          private_key: "{{ test_private_key }}"
        status_code: [200, 201]
      register: key_register

    - name: "GALERA-001: Store key UUID"
      ansible.builtin.set_fact:
        private_key_uuid: "{{ key_register.json.uuid }}"

    - name: "GALERA-001: Distribute public key to app-server-1"
      community.docker.docker_container_exec:
        container: "{{ docker_dev_name_prefix }}-app-server-1"
        command: /bin/bash -c "echo '{{ test_public_key }}' >> /root/.ssh/authorized_keys"
      changed_when: true

    - name: "GALERA-001: Register app-server-1 in Coolify"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/servers"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "test-app-server-1"
          description: "App server for Chatwoot Galera test"
          ip: "172.29.0.20"
          port: 22
          user: "root"
          private_key_uuid: "{{ private_key_uuid }}"
        status_code: [200, 201]
      register: server_register

    - name: "GALERA-001: Store server UUID"
      ansible.builtin.set_fact:
        target_server_uuid: "{{ server_register.json.uuid }}"

    - name: "GALERA-001: Trigger server validation"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/servers/{{ target_server_uuid }}/validate"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 201]
      register: server_validate

    - name: "GALERA-001: Wait for validation to complete"
      ansible.builtin.pause:
        seconds: 15

    - name: "GALERA-001: Get server status"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/servers/{{ target_server_uuid }}"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: server_status

    - name: "GALERA-001: Display server validation status"
      ansible.builtin.debug:
        msg: "Server status: {{ server_status.json.settings.is_validated | default('unknown') }}"

    - name: "GALERA-001: Display server info"
      ansible.builtin.debug:
        msg: "Using server UUID: {{ target_server_uuid }}"

    # Deploy a single MariaDB instance to simulate Galera (for test simplicity)
    - name: "GALERA-002: Create MariaDB database for Chatwoot"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/databases/mariadb"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "chatwoot-db"
          description: "MariaDB for Chatwoot (simulating Galera node)"
          project_uuid: "{{ project_uuid }}"
          environment_name: "{{ environment_name }}"
          server_uuid: "{{ target_server_uuid }}"
          mariadb_root_password: "{{ galera_root_password }}"
          mariadb_database: "{{ galera_app_database }}"
          mariadb_user: "{{ galera_app_user }}"
          mariadb_password: "{{ galera_app_password }}"
          instant_deploy: true
        status_code: [200, 201]
      register: galera_db_create
      when: target_server_uuid is defined

    - name: "GALERA-002: Store database UUID"
      ansible.builtin.set_fact:
        galera_db_uuid: "{{ galera_db_create.json.uuid }}"
      when: galera_db_create is defined and galera_db_create.json is defined

    - name: "GALERA-002: Wait for database to be ready"
      ansible.builtin.pause:
        seconds: 30
      when: galera_db_uuid is defined

    - name: "GALERA-002: Get database details"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/databases/{{ galera_db_uuid }}"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: galera_db_details
      when: galera_db_uuid is defined

    - name: "GALERA-002: Display database info"
      ansible.builtin.debug:
        msg: |
          Database deployed:
          - UUID: {{ galera_db_uuid }}
          - Name: {{ galera_db_details.json.name | default('N/A') }}
          - Status: {{ galera_db_details.json.status | default('N/A') }}
      when: galera_db_uuid is defined

    # ==========================================================================
    # PHASE 2: Deploy Chatwoot One-Click Service
    # ==========================================================================
    - name: "CHATWOOT-001: Create Chatwoot service"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/services"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          type: "chatwoot"
          name: "{{ chatwoot_service_name }}"
          description: "Chatwoot connected to Galera cluster"
          project_uuid: "{{ project_uuid }}"
          environment_name: "{{ environment_name }}"
          server_uuid: "{{ target_server_uuid }}"
          instant_deploy: false
        status_code: [200, 201]
      register: chatwoot_create
      when: target_server_uuid is defined

    - name: "CHATWOOT-001: Store Chatwoot UUID"
      ansible.builtin.set_fact:
        chatwoot_uuid: "{{ chatwoot_create.json.uuid }}"
      when: chatwoot_create is defined and chatwoot_create.json is defined

    - name: "CHATWOOT-001: Display Chatwoot service info"
      ansible.builtin.debug:
        msg: |
          Chatwoot service created:
          - UUID: {{ chatwoot_uuid }}
          - Name: {{ chatwoot_service_name }}
          - Type: chatwoot (one-click)
      when: chatwoot_uuid is defined

    # ==========================================================================
    # PHASE 3: Configure Chatwoot for External Database
    # ==========================================================================
    - name: "CHATWOOT-002: Get Chatwoot service details"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/services/{{ chatwoot_uuid }}"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: chatwoot_details
      when: chatwoot_uuid is defined

    - name: "CHATWOOT-002: Get existing environment variables"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/services/{{ chatwoot_uuid }}/envs"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: chatwoot_envs
      when: chatwoot_uuid is defined

    - name: "CHATWOOT-002: Display current env vars"
      ansible.builtin.debug:
        msg: "Current env vars: {{ chatwoot_envs.json | map(attribute='key') | list }}"
      when: chatwoot_envs is defined and chatwoot_envs.json is defined

    # Configure database connection - these override Chatwoot's internal PostgreSQL
    - name: "CHATWOOT-003: Set external database environment variables"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/services/{{ chatwoot_uuid }}/envs"
        method: PATCH
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          key: "{{ item.key }}"
          value: "{{ item.value }}"
        status_code: [200, 201]
      loop:
        # Database connection pointing to Galera/external DB
        - key: "POSTGRES_HOST"
          value: "{{ galera_hostname }}"
        - key: "POSTGRES_PORT"
          value: "3306"
        - key: "POSTGRES_DATABASE"
          value: "{{ galera_app_database }}"
        - key: "POSTGRES_USERNAME"
          value: "{{ galera_app_user }}"
        - key: "POSTGRES_PASSWORD"
          value: "{{ galera_app_password }}"
        # Chatwoot specific
        - key: "SECRET_KEY_BASE"
          value: "{{ chatwoot_secret_key }}"
        - key: "RAILS_ENV"
          value: "production"
      when: chatwoot_uuid is defined
      ignore_errors: true

    # ==========================================================================
    # PHASE 4: Verify Service Configuration
    # ==========================================================================
    - name: "VERIFY-001: Get updated Chatwoot details"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/services/{{ chatwoot_uuid }}"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: chatwoot_updated
      when: chatwoot_uuid is defined

    - name: "VERIFY-001: Get updated environment variables"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/services/{{ chatwoot_uuid }}/envs"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: chatwoot_envs_updated
      when: chatwoot_uuid is defined

    - name: "VERIFY-001: Assert database config is set"
      ansible.builtin.assert:
        that:
          - "'POSTGRES_HOST' in (chatwoot_envs_updated.json | map(attribute='key') | list)"
        fail_msg: "Database configuration not set"
        success_msg: "Database configuration verified"
      when: chatwoot_envs_updated is defined and chatwoot_envs_updated.json is defined
      ignore_errors: true

    # ==========================================================================
    # PHASE 5: Verify in API Listings
    # ==========================================================================
    - name: "VERIFY-002: List all services"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/services"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: all_services

    - name: "VERIFY-002: Assert Chatwoot in services list"
      ansible.builtin.assert:
        that:
          - all_services.json | selectattr('uuid', 'equalto', chatwoot_uuid) | list | length == 1
        fail_msg: "Chatwoot service not found in API listing"
        success_msg: "Chatwoot service verified in API"
      when: chatwoot_uuid is defined

    - name: "VERIFY-003: List all databases"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/databases"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: all_databases

    - name: "VERIFY-003: Assert database in listing"
      ansible.builtin.assert:
        that:
          - all_databases.json | selectattr('uuid', 'equalto', galera_db_uuid) | list | length == 1
        fail_msg: "Database not found in API listing"
        success_msg: "Database verified in API"
      when: galera_db_uuid is defined

    # ==========================================================================
    # SUMMARY
    # ==========================================================================
    - name: "SUMMARY: Display integration test results"
      ansible.builtin.debug:
        msg: |
          ============================================
          CHATWOOT + GALERA INTEGRATION TEST SUMMARY
          ============================================

          Project: {{ test_project_name }}
          Project UUID: {{ project_uuid }}
          Environment: {{ environment_name }}

          Database (Galera/MariaDB):
          - UUID: {{ galera_db_uuid | default('N/A') }}
          - Name: chatwoot-db
          - Database: {{ galera_app_database }}
          - User: {{ galera_app_user }}
          - Host: {{ galera_hostname }}

          Chatwoot Service:
          - UUID: {{ chatwoot_uuid | default('N/A') }}
          - Name: {{ chatwoot_service_name }}
          - Type: chatwoot (one-click)
          - Database: External ({{ galera_hostname }})

          This pattern works for 200+ Coolify one-click services!
          ============================================

    # ==========================================================================
    # CLEANUP
    # ==========================================================================
    - name: "CLEANUP: Delete Chatwoot service"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/services/{{ chatwoot_uuid }}"
        method: DELETE
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 204, 404]
      when: chatwoot_uuid is defined
      ignore_errors: true

    - name: "CLEANUP: Delete database"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/databases/{{ galera_db_uuid }}"
        method: DELETE
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 204, 404]
      when: galera_db_uuid is defined
      ignore_errors: true

    - name: "CLEANUP: Delete test project"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/projects/{{ project_uuid }}"
        method: DELETE
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 204, 404]
      ignore_errors: true

  # ============================================================================
  # POST_TASKS: Final Cleanup
  # ============================================================================
  post_tasks:
    - name: "CLEANUP: Destroy test containers"
      community.docker.docker_compose_v2:
        project_src: "{{ docker_dev_compose_path }}"
        state: absent
        remove_volumes: true
      ignore_errors: true

    - name: "CLEANUP: Remove test directories"
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ docker_dev_compose_path }}"
        - "{{ docker_dev_logs_path }}"
      ignore_errors: true

    - name: "TEST PASSED: Chatwoot + Galera Integration"
      ansible.builtin.debug:
        msg: |
          All Chatwoot + Galera integration tests passed!
          - Coolify installed via coolify role (not shell commands)
          - API token obtained from role
          - Coolify one-click service (Chatwoot) created
          - External database connection configured
          - Environment variables set for Galera connection
          - Pattern validated for 200+ Coolify services

  tags:
    - test
    - chatwoot
    - galera
    - integration
    - docker-dev
