---
# Test 07: Full Integration
# Tests: Complete end-to-end workflow from container creation to resource management
#
# Uses multi-play structure:
# 1. localhost: Create Docker containers via docker_dev role
# 2. test-controller.lan: Install Coolify via coolify role
# 3. localhost: Run integration tests

# =============================================================================
# PLAY 1: Create Docker Development Environment
# =============================================================================
- name: "Test 07: Setup Docker Environment"
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - conftest.yml
  vars:
    docker_dev_name_prefix: "{{ test_docker_dev_name_prefix }}"
    docker_dev_network_name: "{{ test_docker_dev_network_name }}"
    docker_dev_network_subnet: "{{ test_docker_dev_network_subnet }}"
    docker_dev_network_gateway: "{{ test_docker_dev_network_gateway }}"
    docker_dev_compose_path: "{{ test_docker_dev_compose_path }}"
    docker_dev_logs_path: "{{ test_docker_dev_logs_path }}"
    docker_dev_containers: "{{ test_docker_dev_containers_full }}"
    docker_dev_ssh_keys_path: "{{ test_docker_dev_ssh_keys_path }}"

  tasks:
    - name: "PHASE 1: Display test info"
      ansible.builtin.debug:
        msg: |
          ====================================================================
                    TEST 07: FULL INTEGRATION
          ====================================================================
            Phase 1: Creating Docker development environment
            - Using docker_dev role for container management
            - Using coolify role for Coolify installation
            - Testing complete end-to-end workflow
          ====================================================================

    - name: "PHASE 1: Verify Docker is available"
      community.docker.docker_host_info:
      register: docker_info
      failed_when: docker_info is failed

    - name: "PHASE 1: Check if compose file exists"
      ansible.builtin.stat:
        path: "{{ docker_dev_compose_path }}/docker-compose.yml"
      register: compose_file

    - name: "PHASE 1: Stop existing containers"
      community.docker.docker_compose_v2:
        project_src: "{{ docker_dev_compose_path }}"
        state: absent
        remove_volumes: true
      when: compose_file.stat.exists
      ignore_errors: true

    - name: "PHASE 1: Remove existing directories"
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ docker_dev_compose_path }}"
        - "{{ docker_dev_logs_path }}"
      ignore_errors: true

    - name: "PHASE 1: Create all containers"
      ansible.builtin.include_role:
        name: docker_dev

    - name: "PHASE 1: Verify all containers running"
      community.docker.docker_container_info:
        name: "{{ docker_dev_name_prefix }}-{{ item.name }}"
      register: container_info
      loop: "{{ docker_dev_containers }}"

    - name: "PHASE 1: Assert expected container count"
      ansible.builtin.assert:
        that:
          - container_info.results | selectattr('container.State.Running', 'equalto', true) | list | length == docker_dev_containers | length
        fail_msg: "Expected {{ docker_dev_containers | length }} containers running"
        success_msg: "All {{ docker_dev_containers | length }} containers running"

  tags:
    - test
    - full-integration
    - setup

# =============================================================================
# PLAY 2: Install Coolify via Role
# =============================================================================
- name: "Test 07: Install Coolify via Role"
  hosts: test-controller.lan
  gather_facts: true
  vars_files:
    - conftest.yml
  vars:
    # Coolify role configuration for testing
    coolify_root_username: "admin"
    coolify_root_user_email: "admin@test.local"
    coolify_root_user_password: "TestPassword123!"
    coolify_auto_setup_enabled: true
    coolify_api_base_url: "http://localhost:8000/api/v1"
    coolify_state_path: "./state"
    coolify_docker_address_pool_base: "172.30.0.0/16"
    coolify_docker_address_pool_size: "24"
    coolify_docker_pool_force_override: false
    coolify_autoupdate: false
    coolify_registry_url: "https://hub.docker.com"
    coolify_identity_key_actual_path: "/data/coolify/ssh/keys/id.root@host.docker.internal"
    coolify_detected_key_uuid: ""

  tasks:
    - name: "PHASE 2: Install and configure via coolify role"
      ansible.builtin.include_role:
        name: coolify

    - name: "PHASE 2: Store API token for later plays"
      ansible.builtin.set_fact:
        controller_api_token: "{{ coolify_api_token }}"
        controller_api_ready: "{{ coolify_api_ready }}"
      delegate_to: localhost
      delegate_facts: true

  tags:
    - test
    - full-integration
    - coolify-setup

# =============================================================================
# PLAY 3: Run Integration Tests
# =============================================================================
- name: "Test 07: Full Integration Tests"
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - conftest.yml
  vars:
    docker_dev_name_prefix: "{{ test_docker_dev_name_prefix }}"
    docker_dev_containers: "{{ test_docker_dev_containers_full }}"
    docker_dev_compose_path: "{{ test_docker_dev_compose_path }}"
    docker_dev_logs_path: "{{ test_docker_dev_logs_path }}"
    docker_dev_ssh_keys_path: "{{ test_docker_dev_ssh_keys_path }}"
    controller_container: "{{ docker_dev_name_prefix }}-controller"
    controller_ip: "172.29.0.10"
    coolify_api_base_url: "http://{{ controller_ip }}:8000/api/v1"
    coolify_api_token: "{{ controller_api_token }}"
    test_project_name: "integration-test-project"

  tasks:
    # ==========================================================================
    # PHASE 3: Verify API Setup
    # ==========================================================================
    - name: "PHASE 3: Verify Coolify API is ready"
      ansible.builtin.assert:
        that:
          - controller_api_ready | default(false)
          - controller_api_token | default('') | length > 0
        fail_msg: "Coolify API not ready or token not set"
        success_msg: "Coolify API ready, token configured via role"

    - name: "PHASE 3: Verify API is working"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/version"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: api_check
      retries: 10
      delay: 3
      until: api_check.status == 200

    # ==========================================================================
    # PHASE 4: Register All Nodes
    # ==========================================================================
    - name: "PHASE 4: Get existing SSH keys from Coolify"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/security/keys"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: existing_keys

    - name: "PHASE 4: Store private key UUID"
      ansible.builtin.set_fact:
        private_key_uuid: "{{ existing_keys.json[0].uuid }}"
      when: existing_keys.json | length > 0

    - name: "PHASE 4: Get public key from controller"
      ansible.builtin.slurp:
        src: "{{ (docker_dev_ssh_keys_path | expanduser) }}/test-controller.lan.pub"
      register: controller_pubkey

    - name: "PHASE 4: Distribute public key to worker nodes"
      community.docker.docker_container_exec:
        container: "{{ docker_dev_name_prefix }}-{{ item.name }}"
        command: /bin/bash -c "echo '{{ controller_pubkey.content | b64decode }}' >> /root/.ssh/authorized_keys"
      loop: "{{ docker_dev_containers | rejectattr('name', 'equalto', 'controller') | list }}"
      changed_when: true

    - name: "PHASE 4: Register each worker node"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/servers"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "{{ item.hostname }}"
          description: "Integration test - {{ item.name }}"
          ip: "{{ item.ip }}"
          port: 22
          user: "root"
          private_key_uuid: "{{ private_key_uuid }}"
          is_build_server: "{{ 'builder' in (item.labels | default([])) }}"
        status_code: [200, 201]
      loop: "{{ docker_dev_containers | rejectattr('name', 'equalto', 'controller') | list }}"
      register: node_registrations

    - name: "PHASE 4: Verify all nodes registered"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/servers"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: registered_servers

    - name: "PHASE 4: Assert expected server count"
      ansible.builtin.assert:
        that:
          # +1 for localhost/host.docker.internal
          - registered_servers.json | length >= (docker_dev_containers | rejectattr('name', 'equalto', 'controller') | list | length)
        fail_msg: "Not all servers registered"
        success_msg: "All {{ registered_servers.json | length }} servers registered"

    # ==========================================================================
    # PHASE 5: Project and Environment Setup
    # ==========================================================================
    - name: "PHASE 5: Create test project"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/projects"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "{{ test_project_name }}"
          description: "Integration test project"
        status_code: [200, 201]
      register: project_create

    - name: "PHASE 5: Store project UUID"
      ansible.builtin.set_fact:
        project_uuid: "{{ project_create.json.uuid }}"

    - name: "PHASE 5: Verify project created"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/projects/{{ project_uuid }}"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: project_verify

    - name: "PHASE 5: Assert project exists"
      ansible.builtin.assert:
        that:
          - project_verify.json.name == test_project_name
        fail_msg: "Project not created correctly"
        success_msg: "Project '{{ test_project_name }}' created successfully"

    # ==========================================================================
    # PHASE 6: Resource Cleanup
    # ==========================================================================
    - name: "PHASE 6: Delete test project"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/projects/{{ project_uuid }}"
        method: DELETE
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 204]
      register: project_delete

    - name: "PHASE 6: Delete registered servers"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/servers/{{ item.json.uuid }}"
        method: DELETE
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 204]
      loop: "{{ node_registrations.results }}"
      when: item.json.uuid is defined
      ignore_errors: true

    # ==========================================================================
    # PHASE 7: Final Verification
    # ==========================================================================
    - name: "PHASE 7: Verify all resources cleaned up"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/projects"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: final_projects

    - name: "PHASE 7: Assert test project removed"
      ansible.builtin.assert:
        that:
          - final_projects.json | selectattr('name', 'equalto', test_project_name) | list | length == 0
        fail_msg: "Test project still exists"
        success_msg: "All test resources cleaned up"

    - name: "PHASE 7: Build test summary"
      ansible.builtin.set_fact:
        test_summary:
          coolify_installed_via_role: true
          api_token_from_role: "{{ controller_api_token | length > 0 }}"
          containers_created: "{{ docker_dev_containers | length }}"
          nodes_registered: "{{ node_registrations.results | length }}"
          project_lifecycle_verified: true

    - name: "PHASE 7: Display test summary"
      ansible.builtin.debug:
        msg: |
          ====================================================================
                    FULL INTEGRATION TEST SUMMARY
          ====================================================================
            Coolify Setup (via coolify role):
              Installed via Role: {{ test_summary.coolify_installed_via_role }}
              API Token from Role: {{ test_summary.api_token_from_role }}

            Integration Tests:
              Containers Created: {{ test_summary.containers_created }}
              Nodes Registered: {{ test_summary.nodes_registered }}
              Project Lifecycle: {{ test_summary.project_lifecycle_verified }}

            Overall: PASSED
          ====================================================================

  # ============================================================================
  # CLEANUP
  # ============================================================================
  post_tasks:
    - name: "CLEANUP: Destroy test containers"
      community.docker.docker_compose_v2:
        project_src: "{{ docker_dev_compose_path }}"
        state: absent
        remove_volumes: true
      ignore_errors: true

    - name: "CLEANUP: Remove test directories"
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ docker_dev_compose_path }}"
        - "{{ docker_dev_logs_path }}"
      ignore_errors: true

    - name: "CLEANUP: Remove test SSH keys"
      ansible.builtin.file:
        path: "{{ docker_dev_ssh_keys_path | expanduser }}/{{ item.0.hostname }}{{ item.1 }}"
        state: absent
      loop: "{{ docker_dev_containers | product(['', '.pub']) | list }}"
      when: "'test-' in item.0.hostname"
      ignore_errors: true

    - name: "TEST PASSED: Full Integration"
      ansible.builtin.debug:
        msg: |
          All integration tests passed!
          - Containers: {{ docker_dev_containers | length }} created and verified
          - Coolify: Installed via coolify role
          - API: Token obtained from role
          - Nodes: All registered via API
          - Project: Created and cleaned up

  tags:
    - test
    - full-integration
    - docker-dev
