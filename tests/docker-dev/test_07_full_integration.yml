---
# Test 07: Full Integration
# Tests: Complete end-to-end workflow from container creation to resource management

- name: "Test 07: Full Integration"
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - conftest.yml
  vars:
    docker_dev_name_prefix: "{{ test_docker_dev_name_prefix }}"
    docker_dev_network_name: "{{ test_docker_dev_network_name }}"
    docker_dev_network_subnet: "{{ test_docker_dev_network_subnet }}"
    docker_dev_network_gateway: "{{ test_docker_dev_network_gateway }}"
    docker_dev_compose_path: "{{ test_docker_dev_compose_path }}"
    docker_dev_logs_path: "{{ test_docker_dev_logs_path }}"
    docker_dev_containers: "{{ test_docker_dev_containers_full }}"  # Use full container set
    docker_dev_ssh_keys_path: "{{ test_docker_dev_ssh_keys_path }}"
    controller_container: "{{ docker_dev_name_prefix }}-controller"
    controller_ip: "172.29.0.10"
    coolify_api_base_url: "http://{{ controller_ip }}:8000/api/v1"
    test_project_name: "integration-test-project"

  tasks:
    # ==========================================================================
    # PHASE 1: Environment Setup
    # ==========================================================================
    - name: "PHASE 1: Clean existing environment"
      ansible.builtin.shell: |
        docker compose -f {{ docker_dev_compose_path }}/docker-compose.yml down -v 2>/dev/null || true
        rm -rf {{ docker_dev_compose_path }} {{ docker_dev_logs_path }} 2>/dev/null || true
      changed_when: true
      ignore_errors: true

    - name: "PHASE 1: Create all containers"
      ansible.builtin.include_role:
        name: docker_dev

    - name: "PHASE 1: Wait for all containers to be healthy"
      ansible.builtin.command: >
        docker inspect --format='{{ '{{' }}.State.Health.Status{{ '}}' }}' {{ docker_dev_name_prefix }}-{{ item.name }}
      register: health
      loop: "{{ docker_dev_containers }}"
      changed_when: false
      retries: 60
      delay: 2
      until: health.stdout == 'healthy'

    - name: "PHASE 1: Verify all containers running"
      ansible.builtin.command: >
        docker ps --filter "name={{ docker_dev_name_prefix }}" --format "{{ '{{' }}.Names{{ '}}' }}"
      register: running_containers
      changed_when: false

    - name: "PHASE 1: Assert expected container count"
      ansible.builtin.assert:
        that:
          - running_containers.stdout_lines | length == docker_dev_containers | length
        fail_msg: "Expected {{ docker_dev_containers | length }} containers, got {{ running_containers.stdout_lines | length }}"
        success_msg: "All {{ docker_dev_containers | length }} containers running"

    # ==========================================================================
    # PHASE 2: Coolify Installation
    # ==========================================================================
    - name: "PHASE 2: Download Coolify install script"
      ansible.builtin.command: >
        docker exec {{ controller_container }}
        curl -fsSL https://cdn.coollabs.io/coolify/install.sh -o /root/install.sh
      register: install_download
      changed_when: true
      retries: 3
      delay: 5
      until: install_download.rc == 0

    - name: "PHASE 2: Make install script executable"
      ansible.builtin.command: >
        docker exec {{ controller_container }} chmod +x /root/install.sh
      changed_when: true

    - name: "PHASE 2: Install Coolify on controller"
      ansible.builtin.command: >
        docker exec {{ controller_container }}
        /bin/bash -c "TERM=dumb /root/install.sh"
      register: install
      changed_when: true
      timeout: 900

    - name: "PHASE 2: Wait for Coolify UI"
      ansible.builtin.command: >
        docker exec {{ controller_container }}
        curl -sf -o /dev/null http://localhost:8000
      register: ui_ready
      changed_when: false
      retries: 60
      delay: 5
      until: ui_ready.rc == 0

    # ==========================================================================
    # PHASE 3: API Setup
    # ==========================================================================
    - name: "PHASE 3: Enable API and create token"
      ansible.builtin.shell: |
        docker exec {{ controller_container }} docker exec coolify php artisan tinker --execute='
        $settings = \App\Models\InstanceSettings::first();
        $settings->is_api_enabled = true;
        $settings->allowed_ips = "0.0.0.0";
        $settings->save();
        $user = \App\Models\User::first();
        if (!$user) {
            $user = \App\Models\User::create([
                "name" => "admin",
                "email" => "admin@test.local",
                "password" => \Illuminate\Support\Facades\Hash::make("password123"),
                "email_verified_at" => now(),
            ]);
        }
        $team = $user->teams()->first();
        if (!$team) {
            $team = \App\Models\Team::create([
                "name" => $user->name . " Team",
                "personal_team" => true,
            ]);
            $user->teams()->attach($team->id, ["role" => "admin"]);
        }
        $plainToken = \Illuminate\Support\Str::random(40);
        $newToken = new \Laravel\Sanctum\PersonalAccessToken();
        $newToken->name = "integration-test";
        $newToken->token = hash("sha256", $plainToken);
        $newToken->abilities = ["*"];
        $newToken->tokenable_id = $user->id;
        $newToken->tokenable_type = get_class($user);
        $newToken->team_id = $team->id;
        $newToken->save();
        echo $plainToken;
        '
      register: token_result
      changed_when: true
      retries: 10
      delay: 5
      until: token_result.rc == 0

    - name: "PHASE 3: Extract API token"
      ansible.builtin.set_fact:
        coolify_api_token: "{{ token_result.stdout_lines | last | trim }}"

    - name: "PHASE 3: Verify API is working"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/version"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: api_check
      retries: 10
      delay: 3
      until: api_check.status == 200

    # ==========================================================================
    # PHASE 4: Register All Nodes
    # ==========================================================================
    - name: "PHASE 4: Generate SSH key for node registration"
      ansible.builtin.command: >
        docker exec {{ controller_container }}
        ssh-keygen -t rsa -b 4096 -f /tmp/integration-key -N "" -C "integration-test"
      changed_when: true

    - name: "PHASE 4: Read keys"
      ansible.builtin.command: >
        docker exec {{ controller_container }} cat /tmp/integration-key{{ item }}
      register: ssh_keys
      loop: ["", ".pub"]
      changed_when: false

    - name: "PHASE 4: Set key facts"
      ansible.builtin.set_fact:
        integration_private_key: "{{ ssh_keys.results[0].stdout }}"
        integration_public_key: "{{ ssh_keys.results[1].stdout }}"

    - name: "PHASE 4: Register private key in Coolify"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/security/keys"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "integration-test-key"
          description: "Key for integration test nodes"
          private_key: "{{ integration_private_key }}"
        status_code: [200, 201]
      register: key_register

    - name: "PHASE 4: Store key UUID"
      ansible.builtin.set_fact:
        private_key_uuid: "{{ key_register.json.uuid }}"

    # Register non-controller nodes
    - name: "PHASE 4: Distribute public key to worker nodes"
      ansible.builtin.command: >
        docker exec {{ docker_dev_name_prefix }}-{{ item.name }}
        /bin/bash -c "echo '{{ integration_public_key }}' >> /root/.ssh/authorized_keys"
      loop: "{{ docker_dev_containers | rejectattr('name', 'equalto', 'controller') | list }}"
      changed_when: true

    - name: "PHASE 4: Register each worker node"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/servers"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "{{ item.hostname }}"
          description: "Integration test - {{ item.name }}"
          ip: "{{ item.ip }}"
          port: 22
          user: "root"
          private_key_uuid: "{{ private_key_uuid }}"
          is_build_server: "{{ 'builder' in (item.labels | default([])) }}"
        status_code: [200, 201]
      loop: "{{ docker_dev_containers | rejectattr('name', 'equalto', 'controller') | list }}"
      register: node_registrations

    - name: "PHASE 4: Verify all nodes registered"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/servers"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: registered_servers

    - name: "PHASE 4: Assert expected server count"
      ansible.builtin.assert:
        that:
          # +1 for localhost/host.docker.internal
          - registered_servers.json | length >= (docker_dev_containers | rejectattr('name', 'equalto', 'controller') | list | length)
        fail_msg: "Not all servers registered"
        success_msg: "All {{ registered_servers.json | length }} servers registered"

    # ==========================================================================
    # PHASE 5: Project and Environment Setup
    # ==========================================================================
    - name: "PHASE 5: Create test project"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/projects"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "{{ test_project_name }}"
          description: "Integration test project"
        status_code: [200, 201]
      register: project_create

    - name: "PHASE 5: Store project UUID"
      ansible.builtin.set_fact:
        project_uuid: "{{ project_create.json.uuid }}"

    - name: "PHASE 5: Verify project created"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/projects/{{ project_uuid }}"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: project_verify

    - name: "PHASE 5: Assert project exists"
      ansible.builtin.assert:
        that:
          - project_verify.json.name == test_project_name
        fail_msg: "Project not created correctly"
        success_msg: "Project '{{ test_project_name }}' created successfully"

    # ==========================================================================
    # PHASE 6: Resource Cleanup
    # ==========================================================================
    - name: "PHASE 6: Delete test project"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/projects/{{ project_uuid }}"
        method: DELETE
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 204]
      register: project_delete

    - name: "PHASE 6: Delete registered servers"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/servers/{{ item.json.uuid }}"
        method: DELETE
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 204]
      loop: "{{ node_registrations.results }}"
      when: item.json.uuid is defined
      ignore_errors: true

    - name: "PHASE 6: Delete private key"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/security/keys/{{ private_key_uuid }}"
        method: DELETE
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 204]
      ignore_errors: true

    # ==========================================================================
    # PHASE 7: Final Verification
    # ==========================================================================
    - name: "PHASE 7: Verify all resources cleaned up"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/projects"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: final_projects

    - name: "PHASE 7: Assert test project removed"
      ansible.builtin.assert:
        that:
          - final_projects.json | selectattr('name', 'equalto', test_project_name) | list | length == 0
        fail_msg: "Test project still exists"
        success_msg: "All test resources cleaned up"

  # ============================================================================
  # CLEANUP
  # ============================================================================
  post_tasks:
    - name: "CLEANUP: Destroy test containers"
      ansible.builtin.command: >
        docker compose -f {{ docker_dev_compose_path }}/docker-compose.yml down -v
      changed_when: true
      ignore_errors: true

    - name: "CLEANUP: Remove test directories"
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ docker_dev_compose_path }}"
        - "{{ docker_dev_logs_path }}"
      ignore_errors: true

    - name: "CLEANUP: Remove test SSH keys"
      ansible.builtin.file:
        path: "{{ docker_dev_ssh_keys_path | expanduser }}/{{ item.0.hostname }}{{ item.1 }}"
        state: absent
      loop: "{{ docker_dev_containers | product(['', '.pub']) | list }}"
      when: "'test-' in item.0.hostname"
      ignore_errors: true

    - name: "TEST PASSED: Full Integration"
      ansible.builtin.debug:
        msg: |
          All integration tests passed!
          - Containers: {{ docker_dev_containers | length }} created and verified
          - Coolify: Installed and API enabled
          - Nodes: All registered via API
          - Project: Created and cleaned up

  tags:
    - test
    - full-integration
    - docker-dev
