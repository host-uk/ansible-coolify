---
# Test 17: One-Click App Deployment
#
# Tests: Verify coolify-oneclick-app role detects database requirements and deploys correctly
# This test actually invokes the Ansible role to verify it works
#
# Uses multi-play structure:
# 1. localhost: Create Docker containers via docker_dev role
# 2. test-controller.lan: Install Coolify via coolify role
# 3. localhost: Run the actual One-Click App tests

# =============================================================================
# PLAY 1: Create Docker Development Environment
# =============================================================================
- name: "Test 17: Setup Docker Environment"
  hosts: localhost
  connection: local
  gather_facts: true
  vars_files:
    - conftest.yml
  vars:
    docker_dev_containers: "{{ test_docker_dev_containers_full }}"
    docker_dev_name_prefix: "{{ test_docker_dev_name_prefix }}"
    docker_dev_network_name: "{{ test_docker_dev_network_name }}"
    docker_dev_network_subnet: "{{ test_docker_dev_network_subnet }}"
    docker_dev_network_gateway: "{{ test_docker_dev_network_gateway }}"
    docker_dev_compose_path: "{{ test_docker_dev_compose_path }}"
    docker_dev_logs_path: "{{ test_docker_dev_logs_path }}"
    docker_dev_ssh_keys_path: "{{ test_docker_dev_ssh_keys_path }}"

  tasks:
    - name: "SETUP: Display test info"
      ansible.builtin.debug:
        msg: |
          ====================================================================
                    TEST 17: ONE-CLICK APP ROLE
          ====================================================================
            Phase 1: Creating Docker development environment
            - Using docker_dev role for container management
            - Using coolify role for Coolify installation
            - Using coolify-oneclick-app role for service deployment
          ====================================================================

    - name: "SETUP: Check if compose file exists"
      ansible.builtin.stat:
        path: "{{ docker_dev_compose_path }}/docker-compose.yml"
      register: compose_file

    - name: "SETUP: Stop existing containers"
      community.docker.docker_compose_v2:
        project_src: "{{ docker_dev_compose_path }}"
        state: absent
        remove_volumes: true
      when: compose_file.stat.exists
      ignore_errors: true

    - name: "SETUP: Remove existing directories"
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ docker_dev_compose_path }}"
        - "{{ docker_dev_logs_path }}"
      ignore_errors: true

    - name: "SETUP: Create state directory for test"
      ansible.builtin.file:
        path: "{{ playbook_dir }}/../../state/oneclick"
        state: directory
        mode: '0700'

    - name: "SETUP: Create containers via docker_dev role"
      ansible.builtin.include_role:
        name: docker_dev

  tags:
    - test
    - oneclick-app
    - setup

# =============================================================================
# PLAY 2: Install Coolify via Role
# =============================================================================
- name: "Test 17: Install Coolify via Role"
  hosts: test-controller.lan
  gather_facts: true
  vars_files:
    - conftest.yml
  vars:
    coolify_root_username: "admin"
    coolify_root_user_email: "admin@test.local"
    coolify_root_user_password: "TestPassword123!"
    coolify_auto_setup_enabled: true
    coolify_api_base_url: "http://localhost:8000/api/v1"
    coolify_state_path: "./state"
    coolify_docker_address_pool_base: "172.30.0.0/16"
    coolify_docker_address_pool_size: "24"
    coolify_docker_pool_force_override: false
    coolify_autoupdate: false
    coolify_registry_url: "https://hub.docker.com"
    coolify_identity_key_actual_path: "/data/coolify/ssh/keys/id.root@host.docker.internal"
    coolify_detected_key_uuid: ""

  tasks:
    - name: "COOLIFY: Install and configure via coolify role"
      ansible.builtin.include_role:
        name: coolify

    - name: "COOLIFY: Store API token for later plays"
      ansible.builtin.set_fact:
        controller_api_token: "{{ coolify_api_token }}"
        controller_api_ready: "{{ coolify_api_ready }}"
      delegate_to: localhost
      delegate_facts: true

  tags:
    - test
    - oneclick-app
    - coolify-setup

# =============================================================================
# PLAY 3: Run One-Click App Tests
# =============================================================================
- name: "Test 17: One-Click App Role Tests"
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - conftest.yml
  vars:
    docker_dev_compose_path: "{{ test_docker_dev_compose_path }}"
    docker_dev_logs_path: "{{ test_docker_dev_logs_path }}"
    docker_dev_name_prefix: "{{ test_docker_dev_name_prefix }}"
    docker_dev_ssh_keys_path: "{{ test_docker_dev_ssh_keys_path }}"
    controller_container: "{{ docker_dev_name_prefix }}-controller"
    controller_ip: "172.29.0.10"
    coolify_api_url: "http://{{ controller_ip }}:8000/api/v1"
    coolify_api_token: "{{ controller_api_token }}"

    # Variables for the coolify-oneclick-app role
    oneclick_project_name: "oneclick-test-project"
    oneclick_environment_name: "production"
    oneclick_instant_deploy: false  # Don't auto-deploy for faster testing
    oneclick_auto_create_database: false  # Skip DB creation for basic test
    oneclick_auto_configure_redis: false

  tasks:
    - name: "TEST: Verify Coolify API is ready"
      ansible.builtin.assert:
        that:
          - controller_api_ready | default(false)
          - controller_api_token | default('') | length > 0
        fail_msg: "Coolify API not ready or token not set"
        success_msg: "Coolify API ready, token configured via role"

    - name: "TEST: Verify API access"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/version"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: api_check
      retries: 10
      delay: 3
      until: api_check.status == 200

    # ==========================================================================
    # SETUP: Register Server in Coolify (required for role to work)
    # ==========================================================================
    - name: "SETUP: Read test SSH private key"
      ansible.builtin.slurp:
        src: "{{ docker_dev_ssh_keys_path }}/id_rsa"
      register: test_private_key_content

    - name: "SETUP: Set private key fact"
      ansible.builtin.set_fact:
        test_private_key: "{{ test_private_key_content.content | b64decode }}"

    - name: "SETUP: Register private key in Coolify"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/security/keys"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "oneclick-app-test-key"
          private_key: "{{ test_private_key }}"
        status_code: [200, 201]
      register: private_key_result

    - name: "SETUP: Store private key UUID"
      ansible.builtin.set_fact:
        private_key_uuid: "{{ private_key_result.json.uuid }}"

    - name: "SETUP: Register app-server-1 in Coolify"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/servers"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "test-app-server-1"
          description: "Test server for one-click apps"
          ip: "172.29.0.20"
          port: 22
          user: "root"
          private_key_uuid: "{{ private_key_uuid }}"
        status_code: [200, 201]
      register: server1_result

    - name: "SETUP: Trigger server validation"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/servers/{{ server1_result.json.uuid }}/validate"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 201]

    - name: "SETUP: Store server UUID"
      ansible.builtin.set_fact:
        oneclick_server_uuid: "{{ server1_result.json.uuid }}"

    - name: "SETUP: Wait for server validation"
      ansible.builtin.pause:
        seconds: 15
        prompt: "Waiting for server validation to complete..."

    # ==========================================================================
    # TEST-001: Test Role Loads Database Mappings
    # ==========================================================================
    - name: "TEST-001: Load database mappings from role"
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../../playbooks/roles/coolify-oneclick-app/vars/database_mappings.yml"
        name: db_mappings

    - name: "TEST-001: Assert database mappings loaded"
      ansible.builtin.assert:
        that:
          - db_mappings.postgresql_services is defined
          - db_mappings.mariadb_services is defined
          - db_mappings.redis_required_services is defined
          - db_mappings.standalone_services is defined
          - db_mappings.postgresql_services | length > 0
          - db_mappings.mariadb_services | length > 0
          - db_mappings.standalone_services | length > 0
        fail_msg: "Database mappings not loaded correctly"
        success_msg: "Database mappings loaded: {{ db_mappings.postgresql_services | length }} PostgreSQL, {{ db_mappings.mariadb_services | length }} MariaDB, {{ db_mappings.standalone_services | length }} standalone"

    # ==========================================================================
    # TEST-002: Test Database Detection Task
    # ==========================================================================
    - name: "TEST-002: Test detection for PostgreSQL service (chatwoot)"
      ansible.builtin.include_role:
        name: coolify-oneclick-app
        tasks_from: detect_database.yml
      vars:
        oneclick_service_type: "chatwoot"

    - name: "TEST-002: Assert chatwoot detected as PostgreSQL + Redis"
      ansible.builtin.assert:
        that:
          - oneclick_database_type == 'postgresql'
          - oneclick_requires_postgresql
          - oneclick_requires_redis
          - not oneclick_requires_mariadb
        fail_msg: "Chatwoot not detected correctly: type={{ oneclick_database_type }}"
        success_msg: "Chatwoot correctly detected: PostgreSQL + Redis"

    - name: "TEST-002: Test detection for MariaDB service (wordpress)"
      ansible.builtin.include_role:
        name: coolify-oneclick-app
        tasks_from: detect_database.yml
      vars:
        oneclick_service_type: "wordpress-with-mariadb"

    - name: "TEST-002: Assert wordpress detected as MariaDB"
      ansible.builtin.assert:
        that:
          - oneclick_database_type == 'mariadb'
          - oneclick_requires_mariadb
          - not oneclick_requires_postgresql
        fail_msg: "WordPress not detected correctly: type={{ oneclick_database_type }}"
        success_msg: "WordPress correctly detected: MariaDB"

    - name: "TEST-002: Test detection for standalone service (uptime-kuma)"
      ansible.builtin.include_role:
        name: coolify-oneclick-app
        tasks_from: detect_database.yml
      vars:
        oneclick_service_type: "uptime-kuma"

    - name: "TEST-002: Assert uptime-kuma detected as standalone"
      ansible.builtin.assert:
        that:
          - oneclick_database_type == 'none'
          - not oneclick_requires_postgresql
          - not oneclick_requires_mariadb
          - not oneclick_requires_redis
        fail_msg: "Uptime-kuma not detected correctly: type={{ oneclick_database_type }}"
        success_msg: "Uptime-kuma correctly detected: standalone (no database)"

    # ==========================================================================
    # TEST-003: Test Deploy Task Creates Service via Coolify API
    # ==========================================================================
    - name: "TEST-003: Deploy standalone service using role"
      ansible.builtin.include_role:
        name: coolify-oneclick-app
        tasks_from: deploy.yml
      vars:
        oneclick_service_type: "uptime-kuma"
        oneclick_app_name: "test-uptime-kuma"

    - name: "TEST-003: Assert service was created"
      ansible.builtin.assert:
        that:
          - oneclick_service_uuid is defined
          - oneclick_service_uuid | length > 0
        fail_msg: "Role did not create one-click service"
        success_msg: "Role created one-click service: {{ oneclick_service_uuid }}"

    # ==========================================================================
    # TEST-004: Verify Service Exists in Coolify API
    # ==========================================================================
    - name: "TEST-004: Get service from Coolify API"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/services/{{ oneclick_service_uuid }}"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: service_check

    - name: "TEST-004: Assert service details correct"
      ansible.builtin.assert:
        that:
          - service_check.json.name == "test-uptime-kuma"
          - service_check.json.uuid == oneclick_service_uuid
        fail_msg: "Service details don't match expected values"
        success_msg: "Service verified in Coolify API: {{ service_check.json.name }}"

    # ==========================================================================
    # TEST-005: Test Deploy Another Service Type
    # ==========================================================================
    - name: "TEST-005: Deploy second service (filebrowser)"
      ansible.builtin.include_role:
        name: coolify-oneclick-app
        tasks_from: deploy.yml
      vars:
        oneclick_service_type: "filebrowser"
        oneclick_app_name: "test-filebrowser"

    - name: "TEST-005: Store second service UUID"
      ansible.builtin.set_fact:
        second_service_uuid: "{{ oneclick_service_uuid }}"

    - name: "TEST-005: Assert second service was created"
      ansible.builtin.assert:
        that:
          - second_service_uuid is defined
          - second_service_uuid | length > 0
        fail_msg: "Role did not create second one-click service"
        success_msg: "Role created second one-click service: {{ second_service_uuid }}"

    # ==========================================================================
    # SUMMARY: Test Results
    # ==========================================================================
    - name: "SUMMARY: Build test results"
      ansible.builtin.set_fact:
        test_results:
          coolify_installed_via_role: true
          api_token_from_role: "{{ controller_api_token | length > 0 }}"
          mappings_loaded: true
          postgresql_detection: true
          mariadb_detection: true
          standalone_detection: true
          services_deployed: 2
          first_service_uuid: "{{ service_check.json.uuid }}"
          second_service_uuid: "{{ second_service_uuid }}"

    - name: "SUMMARY: Display test results"
      ansible.builtin.debug:
        msg: |
          ====================================================================
                    ONE-CLICK APP ROLE TEST SUMMARY
          ====================================================================
            Coolify Setup (via coolify role):
              Installed via Role: {{ test_results.coolify_installed_via_role }}
              API Token from Role: {{ test_results.api_token_from_role }}

            Database Mappings Loaded: {{ test_results.mappings_loaded }}
              - PostgreSQL services: {{ db_mappings.postgresql_services | length }}
              - MariaDB services: {{ db_mappings.mariadb_services | length }}
              - Redis required: {{ db_mappings.redis_required_services | length }}
              - Standalone: {{ db_mappings.standalone_services | length }}

            Database Detection Tests:
              PostgreSQL (chatwoot): PASSED
              MariaDB (wordpress): PASSED
              Standalone (uptime-kuma): PASSED

            Service Deployment:
              Services Created: {{ test_results.services_deployed }}
              Service 1 (uptime-kuma): {{ test_results.first_service_uuid }}
              Service 2 (filebrowser): {{ test_results.second_service_uuid }}

            Test Focus: Verified coolify-oneclick-app role correctly
            detects database requirements and deploys via Coolify API

            Overall: PASSED
          ====================================================================

    # ==========================================================================
    # CLEANUP: Remove Test Resources
    # ==========================================================================
    - name: "CLEANUP: Delete first service"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/services/{{ service_check.json.uuid }}"
        method: DELETE
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 204, 404]
      ignore_errors: true

    - name: "CLEANUP: Delete second service"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/services/{{ second_service_uuid }}"
        method: DELETE
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 204, 404]
      ignore_errors: true

    - name: "CLEANUP: Get project UUID"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/projects"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: projects_list

    - name: "CLEANUP: Find test project"
      ansible.builtin.set_fact:
        test_project_uuid: >-
          {{ projects_list.json | selectattr('name', 'equalto', oneclick_project_name) | map(attribute='uuid') | first | default('') }}

    - name: "CLEANUP: Delete test project"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/projects/{{ test_project_uuid }}"
        method: DELETE
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 204, 404]
      when: test_project_uuid != ''
      ignore_errors: true

    - name: "CLEANUP: Delete test server"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/servers/{{ server1_result.json.uuid }}"
        method: DELETE
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 204, 404]
      when: server1_result is defined
      ignore_errors: true

    - name: "CLEANUP: Delete test private key"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/security/keys/{{ private_key_uuid }}"
        method: DELETE
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 204, 404]
      when: private_key_uuid is defined
      ignore_errors: true

  # ============================================================================
  # POST_TASKS: Final Cleanup
  # ============================================================================
  post_tasks:
    - name: "CLEANUP: Destroy test containers"
      community.docker.docker_compose_v2:
        project_src: "{{ docker_dev_compose_path }}"
        state: absent
        remove_volumes: true
      ignore_errors: true

    - name: "CLEANUP: Remove test directories"
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ docker_dev_compose_path }}"
        - "{{ docker_dev_logs_path }}"
      ignore_errors: true

    - name: "TEST COMPLETE: One-Click App Role"
      ansible.builtin.debug:
        msg: |
          One-Click App Role Test Complete!
          - Coolify installed via coolify role
          - Database mappings loaded (100+ services)
          - Database detection works for PostgreSQL, MariaDB, standalone
          - Services deployed via Coolify API
          - Role correctly auto-configures service types

  tags:
    - test
    - oneclick-app
    - role-test
    - docker-dev
