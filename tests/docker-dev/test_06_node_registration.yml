---
# Test 06: Node Registration
# Tests: SSH key distribution, server registration via API
#
# Uses multi-play structure:
# 1. localhost: Create Docker containers via docker_dev role
# 2. test-controller.lan: Install Coolify via coolify role
# 3. localhost: Run node registration tests

# =============================================================================
# PLAY 1: Create Docker Development Environment
# =============================================================================
- name: "Test 06: Setup Docker Environment"
  hosts: localhost
  connection: local
  gather_facts: true
  vars_files:
    - conftest.yml
  vars:
    docker_dev_containers: "{{ test_docker_dev_containers }}"
    docker_dev_name_prefix: "{{ test_docker_dev_name_prefix }}"
    docker_dev_network_name: "{{ test_docker_dev_network_name }}"
    docker_dev_network_subnet: "{{ test_docker_dev_network_subnet }}"
    docker_dev_network_gateway: "{{ test_docker_dev_network_gateway }}"
    docker_dev_compose_path: "{{ test_docker_dev_compose_path }}"
    docker_dev_logs_path: "{{ test_docker_dev_logs_path }}"
    docker_dev_ssh_keys_path: "{{ test_docker_dev_ssh_keys_path }}"

  tasks:
    - name: "SETUP: Display test info"
      ansible.builtin.debug:
        msg: |
          ====================================================================
                    TEST 06: NODE REGISTRATION
          ====================================================================
            Phase 1: Creating Docker development environment
            - Using docker_dev role for container management
            - Using coolify role for Coolify installation
          ====================================================================

    - name: "SETUP: Verify Docker is available"
      community.docker.docker_host_info:
      register: docker_info
      failed_when: docker_info.host_info is not defined

    - name: "SETUP: Check if compose file exists"
      ansible.builtin.stat:
        path: "{{ docker_dev_compose_path }}/docker-compose.yml"
      register: compose_file

    - name: "SETUP: Stop existing containers"
      community.docker.docker_compose_v2:
        project_src: "{{ docker_dev_compose_path }}"
        state: absent
        remove_volumes: true
      when: compose_file.stat.exists
      ignore_errors: true

    - name: "SETUP: Remove existing directories"
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ docker_dev_compose_path }}"
        - "{{ docker_dev_logs_path }}"
      ignore_errors: true

    - name: "SETUP: Create containers via docker_dev role"
      ansible.builtin.include_role:
        name: docker_dev

  tags:
    - test
    - node-registration
    - setup

# =============================================================================
# PLAY 2: Install Coolify via Role
# =============================================================================
- name: "Test 06: Install Coolify via Role"
  hosts: test-controller.lan
  gather_facts: true
  vars_files:
    - conftest.yml
  vars:
    coolify_root_username: "admin"
    coolify_root_user_email: "admin@test.local"
    coolify_root_user_password: "TestPassword123!"
    coolify_auto_setup_enabled: true
    coolify_api_base_url: "http://localhost:8000/api/v1"
    coolify_state_path: "./state"
    coolify_docker_address_pool_base: "172.30.0.0/16"
    coolify_docker_address_pool_size: "24"
    coolify_docker_pool_force_override: false
    coolify_autoupdate: false
    coolify_registry_url: "https://hub.docker.com"
    coolify_identity_key_actual_path: "/data/coolify/ssh/keys/id.root@host.docker.internal"
    coolify_detected_key_uuid: ""

  tasks:
    - name: "COOLIFY: Install and configure via coolify role"
      ansible.builtin.include_role:
        name: coolify

    - name: "COOLIFY: Store API token for later plays"
      ansible.builtin.set_fact:
        controller_api_token: "{{ coolify_api_token }}"
        controller_api_ready: "{{ coolify_api_ready }}"
      delegate_to: localhost
      delegate_facts: true

  tags:
    - test
    - node-registration
    - coolify-setup

# =============================================================================
# PLAY 3: Run Node Registration Tests
# =============================================================================
- name: "Test 06: Node Registration Tests"
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - conftest.yml
  vars:
    docker_dev_containers: "{{ test_docker_dev_containers }}"
    docker_dev_compose_path: "{{ test_docker_dev_compose_path }}"
    docker_dev_logs_path: "{{ test_docker_dev_logs_path }}"
    docker_dev_name_prefix: "{{ test_docker_dev_name_prefix }}"
    controller_container: "{{ docker_dev_name_prefix }}-controller"
    controller_ip: "172.29.0.10"
    worker_container: "{{ docker_dev_name_prefix }}-worker"
    worker_ip: "172.29.0.20"
    coolify_api_base_url: "http://{{ controller_ip }}:8000/api/v1"
    coolify_api_token: "{{ controller_api_token }}"

  tasks:
    - name: "TEST: Verify Coolify API is ready"
      ansible.builtin.assert:
        that:
          - controller_api_ready | default(false)
          - controller_api_token | default('') | length > 0
        fail_msg: "Coolify API not ready or token not set"
        success_msg: "Coolify API ready, token configured via role"

    - name: "TEST: Verify API access"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/version"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: api_check
      retries: 10
      delay: 3
      until: api_check.status == 200

    # ==========================================================================
    # NR-001: Generate SSH Key for Worker Registration
    # ==========================================================================
    - name: "NR-001: Generate SSH key for Coolify to use"
      community.docker.docker_container_exec:
        container: "{{ controller_container }}"
        command: ssh-keygen -t rsa -b 4096 -f /tmp/coolify-test-key -N "" -C "coolify-test"
      register: nr001_keygen
      changed_when: true

    - name: "NR-001: Read public key"
      community.docker.docker_container_exec:
        container: "{{ controller_container }}"
        command: cat /tmp/coolify-test-key.pub
      register: nr001_pubkey
      changed_when: false

    - name: "NR-001: Read private key"
      community.docker.docker_container_exec:
        container: "{{ controller_container }}"
        command: cat /tmp/coolify-test-key
      register: nr001_privkey
      changed_when: false

    # ==========================================================================
    # NR-002: Register Private Key in Coolify
    # ==========================================================================
    - name: "NR-002: Register private key via API"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/security/keys"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "test-worker-key"
          description: "Test key for worker registration"
          private_key: "{{ nr001_privkey.stdout }}"
        status_code: [200, 201]
      register: nr002_key_register

    - name: "NR-002: Extract key UUID"
      ansible.builtin.set_fact:
        private_key_uuid: "{{ nr002_key_register.json.uuid }}"

    - name: "NR-002: Assert key registered"
      ansible.builtin.assert:
        that:
          - private_key_uuid is defined
          - private_key_uuid | length > 0
        fail_msg: "Private key registration failed"
        success_msg: "Private key registered with UUID: {{ private_key_uuid }}"

    # ==========================================================================
    # NR-003: Distribute Public Key to Worker
    # ==========================================================================
    - name: "NR-003: Add public key to worker's authorized_keys"
      community.docker.docker_container_exec:
        container: "{{ worker_container }}"
        command: /bin/bash -c "echo '{{ nr001_pubkey.stdout }}' >> /root/.ssh/authorized_keys"
      changed_when: true

    - name: "NR-003: Verify key in authorized_keys"
      community.docker.docker_container_exec:
        container: "{{ worker_container }}"
        command: cat /root/.ssh/authorized_keys
      register: nr003_authkeys
      changed_when: false

    - name: "NR-003: Assert key distributed"
      ansible.builtin.assert:
        that:
          - "'coolify-test' in nr003_authkeys.stdout"
        fail_msg: "Public key not found in worker authorized_keys"
        success_msg: "Public key distributed to worker"

    # ==========================================================================
    # NR-004: Register Server via API
    # ==========================================================================
    - name: "NR-004: Check if server already exists"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/servers"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: nr004_existing

    - name: "NR-004: Register worker server via API"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/servers"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "test-worker-server"
          description: "Test worker server for node registration"
          ip: "{{ worker_ip }}"
          port: 22
          user: "root"
          private_key_uuid: "{{ private_key_uuid }}"
          is_build_server: false
        status_code: [200, 201]
      register: nr004_register

    - name: "NR-004: Extract server UUID"
      ansible.builtin.set_fact:
        server_uuid: "{{ nr004_register.json.uuid }}"

    - name: "NR-004: Assert server registered"
      ansible.builtin.assert:
        that:
          - server_uuid is defined
          - server_uuid | length > 0
        fail_msg: "Server registration failed"
        success_msg: "Server registered with UUID: {{ server_uuid }}"

    # ==========================================================================
    # NR-005: Verify Server in List
    # ==========================================================================
    - name: "NR-005: List servers to verify registration"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/servers"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: nr005_list

    - name: "NR-005: Assert worker server in list"
      ansible.builtin.assert:
        that:
          - nr005_list.json | selectattr('name', 'equalto', 'test-worker-server') | list | length > 0
        fail_msg: "Registered server not found in list"
        success_msg: "Server found in server list"

    # ==========================================================================
    # NR-006: Test Duplicate Registration (Idempotency)
    # ==========================================================================
    - name: "NR-006: Attempt duplicate registration"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/servers"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "test-worker-server"
          ip: "{{ worker_ip }}"
          port: 22
          user: "root"
          private_key_uuid: "{{ private_key_uuid }}"
        status_code: [200, 201, 400, 409, 422]
      register: nr006_duplicate

    - name: "NR-006: Log duplicate registration result"
      ansible.builtin.debug:
        msg: "Duplicate registration returned status {{ nr006_duplicate.status }}"

    # ==========================================================================
    # NR-007: Validate Server Connection (Optional)
    # ==========================================================================
    - name: "NR-007: Trigger server validation"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/servers/{{ server_uuid }}/validate"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 202]
      register: nr007_validate
      ignore_errors: true

    - name: "NR-007: Log validation result"
      ansible.builtin.debug:
        msg: "Server validation: {{ nr007_validate.json | default('no response') }}"
      when: nr007_validate is succeeded

    # ==========================================================================
    # NR-008: Delete Server (Cleanup Test)
    # ==========================================================================
    - name: "NR-008: Delete registered server"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/servers/{{ server_uuid }}"
        method: DELETE
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 204]
      register: nr008_delete

    - name: "NR-008: Assert server deleted"
      ansible.builtin.assert:
        that:
          - nr008_delete.status in [200, 204]
        fail_msg: "Server deletion failed"
        success_msg: "Server deleted successfully"

    # ==========================================================================
    # NR-009: Verify Server Removed from List
    # ==========================================================================
    - name: "NR-009: List servers after deletion"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/servers"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: nr009_list

    - name: "NR-009: Assert server removed"
      ansible.builtin.assert:
        that:
          - nr009_list.json | selectattr('name', 'equalto', 'test-worker-server') | list | length == 0
        fail_msg: "Deleted server still in list"
        success_msg: "Server correctly removed from list"

  # ============================================================================
  # POST_TASKS: Cleanup
  # ============================================================================
  post_tasks:
    - name: "CLEANUP: Destroy test containers"
      community.docker.docker_compose_v2:
        project_src: "{{ docker_dev_compose_path }}"
        state: absent
        remove_volumes: true
      ignore_errors: true

    - name: "CLEANUP: Remove test directories"
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ docker_dev_compose_path }}"
        - "{{ docker_dev_logs_path }}"
      ignore_errors: true

    - name: "TEST PASSED: Node Registration"
      ansible.builtin.debug:
        msg: "All node registration tests passed!"

  tags:
    - test
    - node-registration
    - docker-dev
