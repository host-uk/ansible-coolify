---
# Test 09: Galera Failover via Role Health Checks
#
# Tests that the coolify-galera role's health_check task correctly monitors
# and reports cluster status, and that services can recover from failures.
#
# Uses multi-play structure:
# 1. localhost: Create Docker containers via docker_dev role
# 2. test-controller.lan: Install Coolify via coolify role
# 3. localhost: Run Galera failover tests
#
# Tests:
# - GF-001: Health check reports healthy after deployment
# - GF-002: Service stop via Coolify API
# - GF-003: Health check detects stopped service
# - GF-004: Service restart via Coolify API
# - GF-005: Data persists through stop/start cycle

# =============================================================================
# PLAY 1: Create Docker Development Environment
# =============================================================================
- name: "Test 09: Setup Docker Environment"
  hosts: localhost
  connection: local
  gather_facts: true
  vars_files:
    - conftest.yml
  vars:
    docker_dev_containers: "{{ test_docker_dev_containers_full }}"
    docker_dev_name_prefix: "{{ test_docker_dev_name_prefix }}"
    docker_dev_network_name: "{{ test_docker_dev_network_name }}"
    docker_dev_network_subnet: "{{ test_docker_dev_network_subnet }}"
    docker_dev_network_gateway: "{{ test_docker_dev_network_gateway }}"
    docker_dev_compose_path: "{{ test_docker_dev_compose_path }}"
    docker_dev_logs_path: "{{ test_docker_dev_logs_path }}"
    docker_dev_ssh_keys_path: "{{ test_docker_dev_ssh_keys_path }}"

  tasks:
    - name: "SETUP: Display test info"
      ansible.builtin.debug:
        msg: |
          ====================================================================
                    TEST 09: GALERA FAILOVER VIA ROLE HEALTH CHECKS
          ====================================================================
            Phase 1: Creating Docker development environment
            - Using docker_dev role for container management
            - Using coolify role for Coolify installation
            - Using coolify-galera role for MariaDB deployment and health checks
          ====================================================================

    - name: "SETUP: Check if compose file exists"
      ansible.builtin.stat:
        path: "{{ docker_dev_compose_path }}/docker-compose.yml"
      register: compose_file

    - name: "SETUP: Stop existing containers"
      community.docker.docker_compose_v2:
        project_src: "{{ docker_dev_compose_path }}"
        state: absent
        remove_volumes: true
      when: compose_file.stat.exists
      ignore_errors: true

    - name: "SETUP: Remove existing directories"
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ docker_dev_compose_path }}"
        - "{{ docker_dev_logs_path }}"
      ignore_errors: true

    - name: "SETUP: Create containers via docker_dev role"
      ansible.builtin.include_role:
        name: docker_dev

  tags:
    - test
    - galera
    - failover
    - setup

# =============================================================================
# PLAY 2: Install Coolify via Role
# =============================================================================
- name: "Test 09: Install Coolify via Role"
  hosts: test-controller.lan
  gather_facts: true
  vars_files:
    - conftest.yml
  vars:
    coolify_root_username: "admin"
    coolify_root_user_email: "admin@test.local"
    coolify_root_user_password: "TestPassword123!"
    coolify_auto_setup_enabled: true
    coolify_api_base_url: "http://localhost:8000/api/v1"
    coolify_state_path: "./state"
    coolify_docker_address_pool_base: "172.30.0.0/16"
    coolify_docker_address_pool_size: "24"
    coolify_docker_pool_force_override: false
    coolify_autoupdate: false
    coolify_registry_url: "https://hub.docker.com"
    coolify_identity_key_actual_path: "/data/coolify/ssh/keys/id.root@host.docker.internal"
    coolify_detected_key_uuid: ""

  tasks:
    - name: "COOLIFY: Install and configure via coolify role"
      ansible.builtin.include_role:
        name: coolify

    - name: "COOLIFY: Store API token for later plays"
      ansible.builtin.set_fact:
        controller_api_token: "{{ coolify_api_token }}"
        controller_api_ready: "{{ coolify_api_ready }}"
      delegate_to: localhost
      delegate_facts: true

  tags:
    - test
    - galera
    - failover
    - coolify-setup

# =============================================================================
# PLAY 3: Run Galera Failover Tests
# =============================================================================
- name: "Test 09: Galera Failover Tests"
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - conftest.yml
  vars:
    docker_dev_compose_path: "{{ test_docker_dev_compose_path }}"
    docker_dev_logs_path: "{{ test_docker_dev_logs_path }}"
    docker_dev_name_prefix: "{{ test_docker_dev_name_prefix }}"
    controller_container: "{{ docker_dev_name_prefix }}-controller"
    controller_ip: "172.29.0.10"
    coolify_api_url: "http://{{ controller_ip }}:8000/api/v1"
    coolify_api_token: "{{ controller_api_token }}"

    # Override role defaults for testing
    galera_cluster_name: "test-failover-cluster"
    galera_project_name: "galera-failover-test"
    galera_environment_name: "testing"
    galera_hostname: "db.test.local"
    galera_root_password: "test_root_password_123"
    galera_app_database: "testdb"
    galera_instant_deploy: true

    # Single node for failover testing
    test_galera_node:
      name: "galera-failover-1"
      host: "test-app-server-1.lan"
      ip: "172.29.0.20"
      role: "master"

    # For health check - single node list
    galera_nodes:
      - name: "galera-failover-1"
        host: "test-app-server-1.lan"
        ip: "172.29.0.20"
        role: "master"

  tasks:
    - name: "TEST: Verify Coolify API is ready"
      ansible.builtin.assert:
        that:
          - controller_api_ready | default(false)
          - controller_api_token | default('') | length > 0
        fail_msg: "Coolify API not ready or token not set"
        success_msg: "Coolify API ready, token configured via role"

    - name: "TEST: Verify API access"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/version"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: api_check
      retries: 10
      delay: 3
      until: api_check.status == 200

    # ==========================================================================
    # SETUP: Register server and deploy Galera node
    # ==========================================================================
    - name: "SETUP: Register test server with Coolify"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/servers"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "failover-test-server"
          description: "Test server for failover testing"
          ip: "{{ test_galera_node.ip }}"
          port: 22
          user: "root"
          private_key_uuid: "{{ (lookup('url', coolify_api_url ~ '/security/keys', headers={'Authorization': 'Bearer ' ~ coolify_api_token}, split_lines=false) | from_json)[0].uuid }}"
        status_code: [200, 201, 422]
      register: server_register

    - name: "SETUP: Deploy Galera node using role"
      ansible.builtin.include_role:
        name: coolify-galera
        tasks_from: deploy_node.yml
      vars:
        galera_current_node: "{{ test_galera_node }}"
        galera_bootstrap_node: true

    - name: "SETUP: Wait for MariaDB container"
      community.docker.docker_container_exec:
        container: "{{ controller_container }}"
        command: /bin/bash -c "docker ps --format '{% raw %}{{.Names}}{% endraw %}' | grep -q galera || exit 1"
      register: container_wait
      retries: 30
      delay: 10
      until: container_wait.rc == 0
      changed_when: false
      ignore_errors: true

    - name: "SETUP: Get container name"
      community.docker.docker_container_exec:
        container: "{{ controller_container }}"
        command: /bin/bash -c "docker ps --format '{% raw %}{{.Names}}{% endraw %}' | grep galera | head -1"
      register: galera_container_name
      changed_when: false
      when: container_wait.rc == 0

    - name: "SETUP: Wait for MariaDB ready"
      community.docker.docker_container_exec:
        container: "{{ controller_container }}"
        command: >
          docker exec {{ galera_container_name.stdout }}
          mariadb -u root -p{{ galera_root_password }} -e "SELECT 1;"
      register: db_ready
      retries: 30
      delay: 5
      until: db_ready.rc == 0
      when: container_wait.rc == 0

    - name: "SETUP: Insert test data"
      community.docker.docker_container_exec:
        container: "{{ controller_container }}"
        command: >
          docker exec {{ galera_container_name.stdout }}
          mariadb -u root -p{{ galera_root_password }} {{ galera_app_database }} -e "
          CREATE TABLE IF NOT EXISTS failover_test (
          id INT AUTO_INCREMENT PRIMARY KEY,
          phase VARCHAR(50),
          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          INSERT INTO failover_test (phase) VALUES ('before-failure');
          "
      when: container_wait.rc == 0 and db_ready.rc == 0

    # ==========================================================================
    # GF-001: Test Health Check Reports Healthy
    # ==========================================================================
    - name: "GF-001: Run health check task (expect healthy)"
      ansible.builtin.include_role:
        name: coolify-galera
        tasks_from: health_check.yml
      vars:
        galera_health_check_strict: false
      when: container_wait.rc == 0

    - name: "GF-001: Assert health check ran"
      ansible.builtin.assert:
        that:
          - galera_health_results is defined
        fail_msg: "Health check did not set galera_health_results"
        success_msg: "GF-001 PASSED: Health check ran, found {{ galera_health_results | length }} services"
      when: container_wait.rc == 0

    # ==========================================================================
    # GF-002: Test Service Stop via API
    # ==========================================================================
    - name: "GF-002: Stop Galera service via Coolify API"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/services/{{ galera_service_uuids[test_galera_node.name] }}/stop"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 202, 204]
      register: service_stop
      when: galera_service_uuids is defined and galera_service_uuids[test_galera_node.name] is defined

    - name: "GF-002: Wait for service to stop"
      ansible.builtin.pause:
        seconds: 10
        prompt: "Waiting for service to stop..."
      when: service_stop is defined and service_stop is not skipped

    - name: "GF-002: Verify container stopped"
      community.docker.docker_container_exec:
        container: "{{ controller_container }}"
        command: /bin/bash -c "docker ps --format '{% raw %}{{.Names}}{% endraw %}' | grep -q galera && exit 1 || exit 0"
      register: container_stopped
      changed_when: false
      ignore_errors: true
      when: service_stop is defined and service_stop is not skipped

    - name: "GF-002: Assert service stopped"
      ansible.builtin.assert:
        that:
          - container_stopped.rc == 0
        fail_msg: "Service did not stop"
        success_msg: "GF-002 PASSED: Service stopped via Coolify API"
      when: container_stopped is defined and container_stopped is not skipped

    # ==========================================================================
    # GF-003: Test Health Check Detects Stopped Service
    # ==========================================================================
    - name: "GF-003: Run health check (expect unhealthy)"
      ansible.builtin.include_role:
        name: coolify-galera
        tasks_from: health_check.yml
      vars:
        galera_health_check_strict: false
      when: container_stopped is defined and container_stopped.rc == 0

    - name: "GF-003: Check if health check detected non-running status"
      ansible.builtin.debug:
        msg: |
          Health check results after stop:
          - Cluster healthy: {{ galera_cluster_healthy | default('undefined') }}
          - Running count: {{ galera_running_count | default('undefined') }}
      when: galera_health_results is defined

    # ==========================================================================
    # GF-004: Test Service Restart via API
    # ==========================================================================
    - name: "GF-004: Start Galera service via Coolify API"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/services/{{ galera_service_uuids[test_galera_node.name] }}/start"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 202, 204]
      register: service_start
      when: galera_service_uuids is defined and galera_service_uuids[test_galera_node.name] is defined

    - name: "GF-004: Wait for service to restart"
      community.docker.docker_container_exec:
        container: "{{ controller_container }}"
        command: /bin/bash -c "docker ps --format '{% raw %}{{.Names}}{% endraw %}' | grep -q galera || exit 1"
      register: container_restarted
      retries: 30
      delay: 10
      until: container_restarted.rc == 0
      changed_when: false
      ignore_errors: true
      when: service_start is defined and service_start is not skipped

    - name: "GF-004: Get restarted container name"
      community.docker.docker_container_exec:
        container: "{{ controller_container }}"
        command: /bin/bash -c "docker ps --format '{% raw %}{{.Names}}{% endraw %}' | grep galera | head -1"
      register: restarted_container_name
      changed_when: false
      when: container_restarted is defined and container_restarted.rc == 0

    - name: "GF-004: Wait for MariaDB to be ready after restart"
      community.docker.docker_container_exec:
        container: "{{ controller_container }}"
        command: >
          docker exec {{ restarted_container_name.stdout }}
          mariadb -u root -p{{ galera_root_password }} -e "SELECT 1;"
      register: db_restart_ready
      retries: 30
      delay: 5
      until: db_restart_ready.rc == 0
      when: restarted_container_name is defined and restarted_container_name.stdout | default('') | length > 0

    - name: "GF-004: Assert service restarted"
      ansible.builtin.assert:
        that:
          - db_restart_ready.rc == 0
        fail_msg: "Service did not restart properly"
        success_msg: "GF-004 PASSED: Service restarted and MariaDB accepting connections"
      when: db_restart_ready is defined

    # ==========================================================================
    # GF-005: Test Data Persistence
    # ==========================================================================
    - name: "GF-005: Check data persisted after restart"
      community.docker.docker_container_exec:
        container: "{{ controller_container }}"
        command: >
          docker exec {{ restarted_container_name.stdout }}
          mariadb -u root -p{{ galera_root_password }} {{ galera_app_database }} -N -e "
          SELECT COUNT(*) FROM failover_test WHERE phase='before-failure';
          "
      register: data_check
      when: restarted_container_name is defined and restarted_container_name.stdout | default('') | length > 0

    - name: "GF-005: Assert data persisted"
      ansible.builtin.assert:
        that:
          - "'1' in data_check.stdout"
        fail_msg: "Data was lost during stop/start cycle"
        success_msg: "GF-005 PASSED: Data persisted through stop/start"
      when: data_check is defined and data_check is not skipped

    - name: "GF-005: Insert post-recovery data"
      community.docker.docker_container_exec:
        container: "{{ controller_container }}"
        command: >
          docker exec {{ restarted_container_name.stdout }}
          mariadb -u root -p{{ galera_root_password }} {{ galera_app_database }} -e "
          INSERT INTO failover_test (phase) VALUES ('after-recovery');
          "
      when: restarted_container_name is defined and restarted_container_name.stdout | default('') | length > 0

    - name: "GF-005: Verify all data present"
      community.docker.docker_container_exec:
        container: "{{ controller_container }}"
        command: >
          docker exec {{ restarted_container_name.stdout }}
          mariadb -u root -p{{ galera_root_password }} {{ galera_app_database }} -N -e "
          SELECT COUNT(*) FROM failover_test;
          "
      register: total_data
      when: restarted_container_name is defined and restarted_container_name.stdout | default('') | length > 0

    - name: "GF-005: Assert all data present"
      ansible.builtin.assert:
        that:
          - "'2' in total_data.stdout"
        fail_msg: "Expected 2 rows after recovery, got {{ total_data.stdout }}"
        success_msg: "GF-005 PASSED: All 2 rows present (before + after recovery)"
      when: total_data is defined and total_data is not skipped

    # ==========================================================================
    # TEST SUMMARY
    # ==========================================================================
    - name: "TEST SUMMARY: Build results"
      ansible.builtin.set_fact:
        test_results:
          coolify_installed_via_role: true
          api_token_from_role: "{{ controller_api_token | length > 0 }}"
          gf001_health_check_initial: "{{ galera_health_results is defined }}"
          gf002_service_stop: "{{ container_stopped.rc | default(1) == 0 }}"
          gf003_health_check_stopped: "{{ galera_cluster_healthy is defined }}"
          gf004_service_restart: "{{ db_restart_ready.rc | default(1) == 0 }}"
          gf005_data_persistence: "{{ total_data.stdout | default('') is search('2') }}"

    - name: "TEST SUMMARY: Display results"
      ansible.builtin.debug:
        msg: |
          ====================================================================
                    TEST 09: GALERA FAILOVER RESULTS
          ====================================================================
            Coolify Setup (via coolify role):
              Installed via Role: {{ test_results.coolify_installed_via_role }}
              API Token from Role: {{ test_results.api_token_from_role }}

            Test Results:
              GF-001 Health Check (Initial): {{ test_results.gf001_health_check_initial }}
              GF-002 Service Stop via API:   {{ test_results.gf002_service_stop }}
              GF-003 Health Check (Stopped): {{ test_results.gf003_health_check_stopped }}
              GF-004 Service Restart:        {{ test_results.gf004_service_restart }}
              GF-005 Data Persistence:       {{ test_results.gf005_data_persistence }}

            Service UUID: {{ galera_service_uuids[test_galera_node.name] | default('N/A') }}

            KEY: This test verifies the coolify-galera role's health
            check task and Coolify API service control work correctly.
          ====================================================================

  # ============================================================================
  # POST_TASKS: Cleanup
  # ============================================================================
  post_tasks:
    - name: "CLEANUP: Delete test service"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/services/{{ galera_service_uuids[test_galera_node.name] }}"
        method: DELETE
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 204, 404]
      ignore_errors: true
      when: galera_service_uuids is defined and galera_service_uuids[test_galera_node.name] is defined

    - name: "CLEANUP: Delete test project"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/projects/{{ galera_project_uuid }}"
        method: DELETE
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 204, 404]
      ignore_errors: true
      when: galera_project_uuid is defined

    - name: "CLEANUP: Destroy test containers"
      community.docker.docker_compose_v2:
        project_src: "{{ docker_dev_compose_path }}"
        state: absent
        remove_volumes: true
      ignore_errors: true

    - name: "CLEANUP: Remove test directories"
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ docker_dev_compose_path }}"
        - "{{ docker_dev_logs_path }}"
      ignore_errors: true

    - name: "TEST PASSED: Galera Failover"
      ansible.builtin.debug:
        msg: |
          All Galera Failover tests completed!
          - Coolify installed via coolify role
          - Health check detects running services
          - Services can be stopped via Coolify API
          - Health check detects stopped services
          - Services can be restarted via Coolify API
          - Data persists through stop/start cycles

  tags:
    - test
    - galera
    - failover
    - role-test
    - docker-dev
