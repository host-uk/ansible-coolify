---
# Test 18: Full Cluster Integration
# Tests: Verify all cluster roles can be loaded and work together
# This test invokes the actual Ansible roles to verify integration
#
# Uses multi-play structure:
# 1. localhost: Create Docker containers via docker_dev role
# 2. test-controller.lan: Install Coolify via coolify role
# 3. localhost: Run integration tests

# =============================================================================
# PLAY 1: Create Docker Development Environment
# =============================================================================
- name: "Test 18: Setup Docker Environment"
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - conftest.yml
  vars:
    docker_dev_name_prefix: "{{ test_docker_dev_name_prefix }}"
    docker_dev_network_name: "{{ test_docker_dev_network_name }}"
    docker_dev_network_subnet: "{{ test_docker_dev_network_subnet }}"
    docker_dev_network_gateway: "{{ test_docker_dev_network_gateway }}"
    docker_dev_compose_path: "{{ test_docker_dev_compose_path }}"
    docker_dev_logs_path: "{{ test_docker_dev_logs_path }}"
    docker_dev_containers: "{{ test_docker_dev_containers_full }}"
    docker_dev_ssh_keys_path: "{{ test_docker_dev_ssh_keys_path }}"

  tasks:
    - name: "SETUP: Display test info"
      ansible.builtin.debug:
        msg: |
          ====================================================================
                    TEST 18: FULL CLUSTER INTEGRATION
          ====================================================================
            Phase 1: Creating Docker development environment
            - Using docker_dev role for container management
            - Using coolify role for Coolify installation
            - Testing all cluster roles integrate correctly
          ====================================================================

    - name: "SETUP: Check if compose file exists"
      ansible.builtin.stat:
        path: "{{ docker_dev_compose_path }}/docker-compose.yml"
      register: compose_file

    - name: "SETUP: Stop existing containers"
      community.docker.docker_compose_v2:
        project_src: "{{ docker_dev_compose_path }}"
        state: absent
        remove_volumes: true
      when: compose_file.stat.exists
      ignore_errors: true

    - name: "SETUP: Remove existing directories"
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ docker_dev_compose_path }}"
        - "{{ docker_dev_logs_path }}"
      ignore_errors: true

    - name: "SETUP: Create containers via docker_dev role"
      ansible.builtin.include_role:
        name: docker_dev

  tags:
    - test
    - full-cluster
    - setup

# =============================================================================
# PLAY 2: Install Coolify via Role
# =============================================================================
- name: "Test 18: Install Coolify via Role"
  hosts: test-controller.lan
  gather_facts: true
  vars_files:
    - conftest.yml
  vars:
    # Coolify role configuration for testing
    coolify_root_username: "admin"
    coolify_root_user_email: "admin@test.local"
    coolify_root_user_password: "TestPassword123!"
    coolify_auto_setup_enabled: true
    coolify_api_base_url: "http://localhost:8000/api/v1"
    coolify_state_path: "./state"
    coolify_docker_address_pool_base: "172.30.0.0/16"
    coolify_docker_address_pool_size: "24"
    coolify_docker_pool_force_override: false
    coolify_autoupdate: false
    coolify_registry_url: "https://hub.docker.com"
    coolify_identity_key_actual_path: "/data/coolify/ssh/keys/id.root@host.docker.internal"
    coolify_detected_key_uuid: ""

  tasks:
    - name: "COOLIFY: Install and configure via coolify role"
      ansible.builtin.include_role:
        name: coolify

    - name: "COOLIFY: Store API token for later plays"
      ansible.builtin.set_fact:
        controller_api_token: "{{ coolify_api_token }}"
        controller_api_ready: "{{ coolify_api_ready }}"
      delegate_to: localhost
      delegate_facts: true

  tags:
    - test
    - full-cluster
    - coolify-setup

# =============================================================================
# PLAY 3: Run Integration Tests
# =============================================================================
- name: "Test 18: Full Cluster Integration Tests"
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - conftest.yml
  vars:
    docker_dev_compose_path: "{{ test_docker_dev_compose_path }}"
    docker_dev_logs_path: "{{ test_docker_dev_logs_path }}"
    controller_ip: "172.29.0.10"
    coolify_api_url: "http://{{ controller_ip }}:8000/api/v1"
    coolify_api_token: "{{ controller_api_token }}"

    # Test node configurations
    test_galera_nodes:
      - name: "galera-test-1"
        host: "app-server-1"
        ip: "172.29.0.20"
        role: "master"
    test_redis_nodes:
      - name: "redis-test-1"
        host: "app-server-1"
        ip: "172.29.0.20"
        role: "master"
    test_postgresql_nodes:
      - name: "postgres-test-1"
        host: "app-server-1"
        ip: "172.29.0.20"
        role: "primary"

  tasks:
    - name: "TEST: Verify API is ready"
      ansible.builtin.assert:
        that:
          - controller_api_ready | default(false)
          - controller_api_token | default('') | length > 0
        fail_msg: "Coolify API not ready or token not set"
        success_msg: "Coolify API ready, token configured via role"

    - name: "TEST: Verify API access"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/version"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: api_check
      retries: 10
      delay: 3
      until: api_check.status == 200

    # ==========================================================================
    # FC-001: Verify All Role Defaults Load Correctly
    # ==========================================================================
    - name: "FC-001: Load Galera role defaults"
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../../playbooks/roles/coolify-galera/defaults/main.yml"
        name: galera_defaults

    - name: "FC-001: Assert Galera defaults loaded"
      ansible.builtin.assert:
        that:
          - galera_defaults.galera_cluster_name is defined
          - galera_defaults.galera_hostname is defined
          - galera_defaults.galera_nodes is defined
        fail_msg: "Galera role defaults not loaded correctly"
        success_msg: "Galera role defaults loaded: {{ galera_defaults.galera_cluster_name }}"

    - name: "FC-001: Load Redis Sentinel role defaults"
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../../playbooks/roles/coolify-redis-sentinel/defaults/main.yml"
        name: redis_defaults

    - name: "FC-001: Assert Redis Sentinel defaults loaded"
      ansible.builtin.assert:
        that:
          - redis_defaults.redis_cluster_name is defined
          - redis_defaults.redis_hostname is defined
          - redis_defaults.redis_nodes is defined
        fail_msg: "Redis Sentinel role defaults not loaded correctly"
        success_msg: "Redis Sentinel role defaults loaded: {{ redis_defaults.redis_cluster_name }}"

    - name: "FC-001: Load PostgreSQL Patroni role defaults"
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../../playbooks/roles/coolify-postgresql/defaults/main.yml"
        name: postgresql_defaults

    - name: "FC-001: Assert PostgreSQL Patroni defaults loaded"
      ansible.builtin.assert:
        that:
          - postgresql_defaults.postgresql_cluster_name is defined
          - postgresql_defaults.postgresql_hostname is defined
          - postgresql_defaults.postgresql_nodes is defined
        fail_msg: "PostgreSQL Patroni role defaults not loaded correctly"
        success_msg: "PostgreSQL Patroni role defaults loaded: {{ postgresql_defaults.postgresql_cluster_name }}"

    - name: "FC-001: Load One-Click App database mappings"
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../../playbooks/roles/coolify-oneclick-app/vars/database_mappings.yml"
        name: db_mappings

    - name: "FC-001: Assert database mappings loaded"
      ansible.builtin.assert:
        that:
          - db_mappings.postgresql_services is defined
          - db_mappings.mariadb_services is defined
          - db_mappings.redis_required_services is defined
          - db_mappings.standalone_services is defined
        fail_msg: "Database mappings not loaded correctly"
        success_msg: "Database mappings loaded: {{ db_mappings.postgresql_services | length }} PostgreSQL, {{ db_mappings.mariadb_services | length }} MariaDB services"

    # ==========================================================================
    # FC-002: Verify State Directories Can Be Created
    # ==========================================================================
    - name: "FC-002: Create state directories"
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0700'
      loop:
        - /tmp/test-state/galera
        - /tmp/test-state/galera/backups
        - /tmp/test-state/redis
        - /tmp/test-state/redis/backups
        - /tmp/test-state/postgresql
        - /tmp/test-state/postgresql/backups
        - /tmp/test-state/oneclick

    - name: "FC-002: Assert directories created"
      ansible.builtin.stat:
        path: "{{ item }}"
      register: state_dirs
      loop:
        - /tmp/test-state/galera
        - /tmp/test-state/redis
        - /tmp/test-state/postgresql
        - /tmp/test-state/oneclick

    - name: "FC-002: Verify all state directories exist"
      ansible.builtin.assert:
        that:
          - item.stat.exists
          - item.stat.isdir
        fail_msg: "State directory not created: {{ item.item }}"
        success_msg: "State directory exists: {{ item.item }}"
      loop: "{{ state_dirs.results }}"
      loop_control:
        label: "{{ item.item }}"

    # ==========================================================================
    # FC-003: Verify API Can Create Projects for Each Cluster
    # ==========================================================================
    - name: "FC-003: Create Galera project"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/projects"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "galera-cluster-test"
          description: "Test Galera cluster project"
        status_code: [200, 201]
      register: galera_project

    - name: "FC-003: Create Redis project"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/projects"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "redis-cluster-test"
          description: "Test Redis Sentinel cluster project"
        status_code: [200, 201]
      register: redis_project

    - name: "FC-003: Create PostgreSQL project"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/projects"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "postgresql-cluster-test"
          description: "Test PostgreSQL Patroni cluster project"
        status_code: [200, 201]
      register: postgresql_project

    - name: "FC-003: Create One-Click Apps project"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/projects"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "oneclick-apps-test"
          description: "Test One-Click applications project"
        status_code: [200, 201]
      register: oneclick_project

    - name: "FC-003: Assert all projects created"
      ansible.builtin.assert:
        that:
          - galera_project.json.uuid is defined
          - redis_project.json.uuid is defined
          - postgresql_project.json.uuid is defined
          - oneclick_project.json.uuid is defined
        fail_msg: "Not all projects were created successfully"
        success_msg: "All cluster projects created successfully"

    # ==========================================================================
    # FC-004: Verify Projects Appear in API
    # ==========================================================================
    - name: "FC-004: List all projects"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/projects"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: all_projects

    - name: "FC-004: Assert projects in listing"
      ansible.builtin.assert:
        that:
          - all_projects.json | selectattr('name', 'equalto', 'galera-cluster-test') | list | length == 1
          - all_projects.json | selectattr('name', 'equalto', 'redis-cluster-test') | list | length == 1
          - all_projects.json | selectattr('name', 'equalto', 'postgresql-cluster-test') | list | length == 1
          - all_projects.json | selectattr('name', 'equalto', 'oneclick-apps-test') | list | length == 1
        fail_msg: "Not all projects found in listing"
        success_msg: "All projects correctly appear in API listing"

    # ==========================================================================
    # FC-005: Test Summary
    # ==========================================================================
    - name: "FC-005: Build test summary"
      ansible.builtin.set_fact:
        test_summary:
          coolify_installed_via_role: true
          api_token_from_role: "{{ controller_api_token | length > 0 }}"
          galera_defaults_loaded: "{{ galera_defaults.galera_cluster_name is defined }}"
          redis_defaults_loaded: "{{ redis_defaults.redis_cluster_name is defined }}"
          postgresql_defaults_loaded: "{{ postgresql_defaults.postgresql_cluster_name is defined }}"
          db_mappings_loaded: "{{ db_mappings.postgresql_services is defined }}"
          state_dirs_created: true
          galera_project_created: "{{ galera_project.json.uuid is defined }}"
          redis_project_created: "{{ redis_project.json.uuid is defined }}"
          postgresql_project_created: "{{ postgresql_project.json.uuid is defined }}"
          oneclick_project_created: "{{ oneclick_project.json.uuid is defined }}"
          total_services_mapped: "{{ db_mappings.postgresql_services | length + db_mappings.mariadb_services | length + db_mappings.standalone_services | length }}"

    - name: "FC-005: Display test summary"
      ansible.builtin.debug:
        msg: |
          ====================================================================
                    FULL CLUSTER INTEGRATION TEST SUMMARY
          ====================================================================
            Coolify Setup (via coolify role):
              Installed via Role: {{ test_summary.coolify_installed_via_role }}
              API Token from Role: {{ test_summary.api_token_from_role }}

            Role Defaults (via include_vars from role directories):
              Galera Loaded: {{ test_summary.galera_defaults_loaded }}
              Redis Sentinel Loaded: {{ test_summary.redis_defaults_loaded }}
              PostgreSQL Patroni Loaded: {{ test_summary.postgresql_defaults_loaded }}
              Database Mappings Loaded: {{ test_summary.db_mappings_loaded }}

            State Management:
              Directories Created: {{ test_summary.state_dirs_created }}

            Coolify Projects:
              Galera Project: {{ test_summary.galera_project_created }}
              Redis Project: {{ test_summary.redis_project_created }}
              PostgreSQL Project: {{ test_summary.postgresql_project_created }}
              One-Click Project: {{ test_summary.oneclick_project_created }}

            One-Click App Coverage:
              Total Services Mapped: {{ test_summary.total_services_mapped }}
              PostgreSQL Services: {{ db_mappings.postgresql_services | length }}
              MariaDB Services: {{ db_mappings.mariadb_services | length }}
              Redis Required: {{ db_mappings.redis_required_services | length }}
              Standalone: {{ db_mappings.standalone_services | length }}

            Test Focus: Verified all cluster roles load correctly
            and can work together via Coolify API

            Overall: PASSED
          ====================================================================

    # ==========================================================================
    # CLEANUP: Remove Test Resources
    # ==========================================================================
    - name: "CLEANUP: Delete test projects"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/projects/{{ item }}"
        method: DELETE
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 204, 404]
      loop:
        - "{{ galera_project.json.uuid }}"
        - "{{ redis_project.json.uuid }}"
        - "{{ postgresql_project.json.uuid }}"
        - "{{ oneclick_project.json.uuid }}"
      ignore_errors: true

    - name: "CLEANUP: Remove test state directories"
      ansible.builtin.file:
        path: /tmp/test-state
        state: absent

  # ============================================================================
  # POST_TASKS: Final Cleanup
  # ============================================================================
  post_tasks:
    - name: "CLEANUP: Destroy test containers"
      community.docker.docker_compose_v2:
        project_src: "{{ docker_dev_compose_path }}"
        state: absent
        remove_volumes: true
      ignore_errors: true

    - name: "CLEANUP: Remove test directories"
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ docker_dev_compose_path }}"
        - "{{ docker_dev_logs_path }}"
      ignore_errors: true

    - name: "TEST PASSED: Full Cluster Integration"
      ansible.builtin.debug:
        msg: |
          All Full Cluster Integration tests passed!
          - Coolify installed via coolify role (not shell commands)
          - API token obtained from role
          - All role defaults load correctly
          - State directories can be created
          - Coolify projects for all clusters can be created
          - Database mappings cover 100+ services
          - Roles are properly integrated and ready for deployment

  tags:
    - test
    - full-cluster
    - role-test
    - docker-dev
