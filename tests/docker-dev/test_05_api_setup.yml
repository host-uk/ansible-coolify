---
# Test 05: API Setup
# Tests: API token generation, validation, and persistence
# Uses multi-play pattern:
#   - Play 1: localhost - setup containers via docker_dev role
#   - Play 2: target host - install Coolify via coolify role (which handles API setup)
#   - Play 3: localhost - run API verification tests

# ==============================================================================
# PLAY 1: Setup Docker Development Environment
# ==============================================================================
- name: "Test 05 - Play 1: Setup Docker Environment"
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - conftest.yml
  vars:
    docker_dev_name_prefix: "{{ test_docker_dev_name_prefix }}"
    docker_dev_network_name: "{{ test_docker_dev_network_name }}"
    docker_dev_network_subnet: "{{ test_docker_dev_network_subnet }}"
    docker_dev_network_gateway: "{{ test_docker_dev_network_gateway }}"
    docker_dev_compose_path: "{{ test_docker_dev_compose_path }}"
    docker_dev_logs_path: "{{ test_docker_dev_logs_path }}"
    docker_dev_containers: "{{ test_docker_dev_containers }}"
    docker_dev_ssh_keys_path: "{{ test_docker_dev_ssh_keys_path }}"

  tasks:
    - name: "SETUP: Verify Docker is available"
      community.docker.docker_host_info:
      register: docker_info
      failed_when: docker_info.host_info is not defined

    - name: "SETUP: Check for existing compose file"
      ansible.builtin.stat:
        path: "{{ docker_dev_compose_path }}/docker-compose.yml"
      register: compose_file_stat

    - name: "SETUP: Stop existing containers"
      community.docker.docker_compose_v2:
        project_src: "{{ docker_dev_compose_path }}"
        state: absent
        remove_volumes: true
      when: compose_file_stat.stat.exists
      ignore_errors: true

    - name: "SETUP: Remove test directories"
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ docker_dev_compose_path }}"
        - "{{ docker_dev_logs_path }}"
      ignore_errors: true

    - name: "SETUP: Create containers with docker_dev role"
      ansible.builtin.include_role:
        name: docker_dev

    - name: "SETUP: Add controller to dynamic inventory group"
      ansible.builtin.add_host:
        name: "{{ (docker_dev_containers | selectattr('name', 'equalto', 'controller') | first).hostname }}"
        groups:
          - test_controllers
          - controller
        ansible_host: "{{ (docker_dev_containers | selectattr('name', 'equalto', 'controller') | first).ip }}"
        ansible_user: root
        ansible_ssh_private_key_file: "{{ (docker_dev_ssh_keys_path | expanduser) }}/{{ (docker_dev_containers | selectattr('name', 'equalto', 'controller') | first).hostname }}"
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
        coolify_root_user_email: "admin@test.local"
        coolify_root_user_password: "Password123!"
        coolify_auto_setup_enabled: true
        private_ip: "{{ (docker_dev_containers | selectattr('name', 'equalto', 'controller') | first).ip }}"

  tags:
    - test
    - api-setup
    - docker-dev

# ==============================================================================
# PLAY 2: Install Coolify and Setup API via Role
# ==============================================================================
- name: "Test 05 - Play 2: Install Coolify via Role"
  hosts: test_controllers
  gather_facts: true
  vars_files:
    - conftest.yml
  vars:
    # Override for test environment
    coolify_state_path: "{{ playbook_dir }}/test-state"
    common_manage_ufw: false

  tasks:
    - name: "INSTALL: Wait for target host to be ready"
      ansible.builtin.wait_for_connection:
        delay: 5
        timeout: 120

    - name: "INSTALL: Install Coolify via coolify role"
      ansible.builtin.include_role:
        name: coolify

    - name: "INSTALL: Store API token for next play"
      ansible.builtin.set_fact:
        stored_api_token: "{{ coolify_api_token | default('') }}"
        stored_api_ready: "{{ coolify_api_ready | default(false) }}"
      delegate_to: localhost
      delegate_facts: true

  tags:
    - test
    - api-setup
    - docker-dev

# ==============================================================================
# PLAY 3: Run API Verification Tests
# ==============================================================================
- name: "Test 05 - Play 3: API Verification Tests"
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - conftest.yml
  vars:
    docker_dev_compose_path: "{{ test_docker_dev_compose_path }}"
    docker_dev_logs_path: "{{ test_docker_dev_logs_path }}"
    controller_ip: "172.29.0.10"
    coolify_api_base_url: "http://{{ controller_ip }}:8000/api/v1"
    coolify_api_token: "{{ hostvars['localhost']['stored_api_token'] | default('') }}"

  tasks:
    # ==========================================================================
    # API-001: Verify API Token Was Generated
    # ==========================================================================
    - name: "API-001: Assert API token was generated by coolify role"
      ansible.builtin.assert:
        that:
          - coolify_api_token is defined
          - coolify_api_token | length > 20
        fail_msg: "API token not generated or too short (length: {{ coolify_api_token | default('') | length }})"
        success_msg: "API token generated ({{ coolify_api_token | length }} chars)"

    # ==========================================================================
    # API-002: Validate Token via API Version Endpoint
    # ==========================================================================
    - name: "API-002: Test API with token (version endpoint)"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/version"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Accept: "application/json"
        return_content: true
        status_code: 200
      register: api002_version
      retries: 10
      delay: 3
      until: api002_version.status == 200

    - name: "API-002: Assert API responds correctly"
      ansible.builtin.assert:
        that:
          - api002_version.status == 200
          - api002_version.content is defined
          - api002_version.content | length > 0
        fail_msg: "API validation failed: {{ api002_version }}"
        success_msg: "API responding correctly, version: {{ api002_version.content }}"

    # ==========================================================================
    # API-003: Test List Servers Endpoint
    # ==========================================================================
    - name: "API-003: Test list servers endpoint"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/servers"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Accept: "application/json"
        return_content: true
        status_code: 200
      register: api003_servers

    - name: "API-003: Assert servers endpoint works"
      ansible.builtin.assert:
        that:
          - api003_servers.status == 200
          - api003_servers.json is defined
        fail_msg: "Servers endpoint failed"
        success_msg: "Servers endpoint working, found {{ api003_servers.json | length }} servers"

    # ==========================================================================
    # API-004: Test List Projects Endpoint
    # ==========================================================================
    - name: "API-004: Test list projects endpoint"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/projects"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Accept: "application/json"
        return_content: true
        status_code: 200
      register: api004_projects

    - name: "API-004: Assert projects endpoint works"
      ansible.builtin.assert:
        that:
          - api004_projects.status == 200
        fail_msg: "Projects endpoint failed"
        success_msg: "Projects endpoint working"

    # ==========================================================================
    # API-005: Test Invalid Token Rejected
    # ==========================================================================
    - name: "API-005: Test invalid token is rejected"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/version"
        method: GET
        headers:
          Authorization: "Bearer invalid-token-12345"
          Accept: "application/json"
        status_code: [401, 403]
      register: api005_invalid

    - name: "API-005: Assert invalid token rejected"
      ansible.builtin.assert:
        that:
          - api005_invalid.status in [401, 403]
        fail_msg: "Invalid token was not rejected"
        success_msg: "Invalid token correctly rejected (HTTP {{ api005_invalid.status }})"

    # ==========================================================================
    # API-006: Test Token Reuse After Role Completion
    # ==========================================================================
    - name: "API-006: Verify token can be reused for multiple API calls"
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/{{ item }}"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Accept: "application/json"
        status_code: 200
      loop:
        - version
        - servers
        - projects
      register: api006_multiple

    - name: "API-006: Assert all endpoints accessible with same token"
      ansible.builtin.assert:
        that:
          - api006_multiple.results | map(attribute='status') | list | unique == [200]
        fail_msg: "Token reuse failed for some endpoints"
        success_msg: "Token works for multiple API calls"

    # ==========================================================================
    # API-007: Verify API Ready Flag
    # ==========================================================================
    - name: "API-007: Check API ready flag from coolify role"
      ansible.builtin.assert:
        that:
          - hostvars['localhost']['stored_api_ready'] | default(false) | bool
        fail_msg: "Coolify role did not set API ready flag"
        success_msg: "API ready flag correctly set by coolify role"

  # ============================================================================
  # CLEANUP
  # ============================================================================
  post_tasks:
    - name: "CLEANUP: Check for compose file"
      ansible.builtin.stat:
        path: "{{ docker_dev_compose_path }}/docker-compose.yml"
      register: cleanup_compose_stat

    - name: "CLEANUP: Destroy test containers"
      community.docker.docker_compose_v2:
        project_src: "{{ docker_dev_compose_path }}"
        state: absent
        remove_volumes: true
      when: cleanup_compose_stat.stat.exists
      ignore_errors: true

    - name: "CLEANUP: Remove test directories"
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ docker_dev_compose_path }}"
        - "{{ docker_dev_logs_path }}"
        - "{{ playbook_dir }}/test-state"
      ignore_errors: true

    - name: "TEST PASSED: API Setup"
      ansible.builtin.debug:
        msg: "All API setup tests passed!"

  tags:
    - test
    - api-setup
    - docker-dev
