---
# Move Resources Between Environments
# Moves services from source to target environment (recreate + delete source)
#
# Usage:
#   # Move all services from one env to another
#   ansible-playbook playbooks/coolify/environment/move.yml \
#     -e source_project=example -e source_env=staging \
#     -e target_project=example -e target_env=production
#
#   # Move specific service types only
#   ansible-playbook playbooks/coolify/environment/move.yml \
#     -e source_project=example -e source_env=staging \
#     -e target_project=example -e target_env=production \
#     -e "service_types=['chatwoot']"
#
# Options:
#   -e dry_run=true         Preview without making changes
#   -e move_envs=true       Also move environment variables (default: true)
#   -e keep_source=true     Don't delete source (effectively a clone)
#   -e server_uuid=xxx      Override server for target resources

- name: Move Resources Between Environments
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    # API settings
    coolify_api_url: "http://172.28.0.10:8000/api/v1"
    coolify_api_token: "cn2oEwlO2atkexV3AwlNYroVwk5IWAJxJ4umultx"

    # Source and target (required via -e)
    source_project: ""
    source_env: ""
    target_project: ""
    target_env: ""

    # Options
    dry_run: false
    move_envs: true
    keep_source: false
    service_types: []  # Empty = all services

  tasks:
    # =========================================================================
    # PHASE 1: Validate inputs
    # =========================================================================
    - name: "Validate required parameters"
      ansible.builtin.fail:
        msg: "Required: -e source_project=xxx -e source_env=yyy -e target_project=zzz -e target_env=www"
      when: source_project == "" or source_env == "" or target_project == "" or target_env == ""

    - name: "Prevent moving to same environment"
      ansible.builtin.fail:
        msg: "Source and target cannot be the same environment"
      when: source_project == target_project and source_env == target_env

    # =========================================================================
    # PHASE 2: Resolve source environment
    # =========================================================================
    - name: "Get all projects"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/projects"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: all_projects

    - name: "Find source project"
      ansible.builtin.set_fact:
        src_project: "{{ all_projects.json | selectattr('name', 'equalto', source_project) | first | default(none) }}"

    - name: "Fail if source project not found"
      ansible.builtin.fail:
        msg: "Source project '{{ source_project }}' not found"
      when: src_project is none

    - name: "Get source project details"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/projects/{{ src_project.uuid }}"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: src_project_details

    - name: "Find source environment"
      ansible.builtin.set_fact:
        src_env: "{{ src_project_details.json.environments | selectattr('name', 'equalto', source_env) | first | default(none) }}"

    - name: "Fail if source environment not found"
      ansible.builtin.fail:
        msg: "Source environment '{{ source_env }}' not found in project '{{ source_project }}'"
      when: src_env is none

    # =========================================================================
    # PHASE 3: Resolve target environment
    # =========================================================================
    - name: "Find target project"
      ansible.builtin.set_fact:
        tgt_project: "{{ all_projects.json | selectattr('name', 'equalto', target_project) | first | default(none) }}"

    - name: "Fail if target project not found"
      ansible.builtin.fail:
        msg: "Target project '{{ target_project }}' not found"
      when: tgt_project is none

    - name: "Get target project details"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/projects/{{ tgt_project.uuid }}"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: tgt_project_details

    - name: "Find target environment"
      ansible.builtin.set_fact:
        tgt_env: "{{ tgt_project_details.json.environments | selectattr('name', 'equalto', target_env) | first | default(none) }}"

    - name: "Fail if target environment not found"
      ansible.builtin.fail:
        msg: "Target environment '{{ target_env }}' not found in project '{{ target_project }}'"
      when: tgt_env is none

    # =========================================================================
    # PHASE 4: Get source services
    # =========================================================================
    - name: "Get all services"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/services"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: all_services

    - name: "Filter source services"
      ansible.builtin.set_fact:
        source_services_all: "{{ all_services.json | selectattr('environment_id', 'equalto', src_env.id) | list }}"

    - name: "Apply service type filter"
      ansible.builtin.set_fact:
        source_services: "{{ source_services_all | selectattr('service_type', 'in', service_types) | list if service_types | length > 0 else source_services_all }}"

    - name: "Fail if no services to move"
      ansible.builtin.fail:
        msg: "No services found in {{ source_project }}/{{ source_env }}{{ ' matching filter: ' + (service_types | join(', ')) if service_types | length > 0 else '' }}"
      when: source_services | length == 0

    - name: "Get target server UUID"
      ansible.builtin.set_fact:
        target_server_uuid: "{{ server_uuid | default(source_services[0].server.uuid) }}"

    - name: "Get existing target services"
      ansible.builtin.set_fact:
        target_existing: "{{ all_services.json | selectattr('environment_id', 'equalto', tgt_env.id) | map(attribute='service_type') | list }}"

    - name: "Identify services to move"
      ansible.builtin.set_fact:
        services_to_move: "{{ source_services | rejectattr('service_type', 'in', target_existing) | list }}"
        services_conflict: "{{ source_services | selectattr('service_type', 'in', target_existing) | list }}"

    # =========================================================================
    # PHASE 5: Display move plan
    # =========================================================================
    - name: "Display move plan"
      ansible.builtin.debug:
        msg: |
          ╔══════════════════════════════════════════════════════════════════╗
          ║                         MOVE PLAN                                ║
          ╠══════════════════════════════════════════════════════════════════╣
          ║                                                                  ║
          ║  Source: {{ source_project }}/{{ source_env }}
          ║  Target: {{ target_project }}/{{ target_env }}
          ║  Mode: {{ 'DRY RUN' if dry_run | bool else 'LIVE' }}{{ ' (KEEP SOURCE)' if keep_source | bool else '' }}
          ║                                                                  ║
          ╠══════════════════════════════════════════════════════════════════╣
          ║                                                                  ║
          ║  TO MOVE: {{ services_to_move | length }}
          {% for svc in services_to_move %}
          ║    → {{ svc.service_type }} ({{ svc.name }})
          {% endfor %}
          {% if services_to_move | length == 0 %}
          ║    (none)
          {% endif %}
          ║                                                                  ║
          {% if services_conflict | length > 0 %}
          ║  CONFLICT (exists in target): {{ services_conflict | length }}
          {% for svc in services_conflict %}
          ║    ✗ {{ svc.service_type }} - skipped
          {% endfor %}
          ║                                                                  ║
          {% endif %}
          ║  Options:                                                        ║
          ║    Move env vars: {{ 'yes' if move_envs | bool else 'no' }}
          ║    Delete source: {{ 'no (keep)' if keep_source | bool else 'yes' }}
          ║                                                                  ║
          ╚══════════════════════════════════════════════════════════════════╝

    # =========================================================================
    # PHASE 6: Get source environment variables
    # =========================================================================
    - name: "Get source environment variables"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/services/{{ item.uuid }}/envs"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: [200, 404]
      loop: "{{ services_to_move }}"
      loop_control:
        label: "{{ item.service_type }}"
      register: source_envs
      when:
        - services_to_move | length > 0
        - move_envs | bool

    # =========================================================================
    # PHASE 7: Create services in target
    # =========================================================================
    - name: "Create services in target"
      when:
        - services_to_move | length > 0
        - not (dry_run | bool)
      block:
        - name: "Create each service"
          ansible.builtin.uri:
            url: "{{ coolify_api_url }}/services"
            method: POST
            headers:
              Authorization: "Bearer {{ coolify_api_token }}"
              Content-Type: "application/json"
            body_format: json
            body:
              type: "{{ item.service_type }}"
              project_uuid: "{{ tgt_project.uuid }}"
              server_uuid: "{{ target_server_uuid }}"
              environment_name: "{{ target_env }}"
              description: "{{ item.description | default(omit) }}"
            status_code: [200, 201]
          loop: "{{ services_to_move }}"
          loop_control:
            label: "{{ item.service_type }}"
          register: created_services

        - name: "Display created services"
          ansible.builtin.debug:
            msg: |
              Created {{ created_services.results | length }} services in target:
              {% for result in created_services.results %}
              {% if result.json is defined %}
                - {{ result.item.service_type }} → {{ result.json.uuid }}
              {% endif %}
              {% endfor %}

    # =========================================================================
    # PHASE 8: Copy environment variables
    # =========================================================================
    - name: "Copy environment variables"
      when:
        - services_to_move | length > 0
        - move_envs | bool
        - not (dry_run | bool)
      block:
        - name: "Get new service UUIDs"
          ansible.builtin.uri:
            url: "{{ coolify_api_url }}/services"
            method: GET
            headers:
              Authorization: "Bearer {{ coolify_api_token }}"
            status_code: 200
          register: updated_services

        - name: "Build target service UUID map"
          ansible.builtin.set_fact:
            target_uuid_map: "{{ dict(updated_services.json | selectattr('environment_id', 'equalto', tgt_env.id) | map(attribute='service_type') | zip(updated_services.json | selectattr('environment_id', 'equalto', tgt_env.id) | map(attribute='uuid'))) }}"

        - name: "Copy env vars for each service"
          ansible.builtin.include_tasks: move_envs.yml
          loop: "{{ source_envs.results | default([]) }}"
          loop_control:
            label: "{{ env_result.item.service_type }}"
            loop_var: env_result
          when:
            - env_result.status is defined
            - env_result.status == 200
            - env_result.item.service_type in target_uuid_map

    # =========================================================================
    # PHASE 9: Delete source services
    # =========================================================================
    - name: "Delete source services"
      when:
        - services_to_move | length > 0
        - not (dry_run | bool)
        - not (keep_source | bool)
      block:
        - name: "Delete each source service"
          ansible.builtin.uri:
            url: "{{ coolify_api_url }}/services/{{ item.uuid }}?delete_configurations=true&delete_volumes=true"
            method: DELETE
            headers:
              Authorization: "Bearer {{ coolify_api_token }}"
            status_code: [200, 202, 204]
          loop: "{{ services_to_move }}"
          loop_control:
            label: "{{ item.service_type }}"
          register: deleted_services

        - name: "Display deleted services"
          ansible.builtin.debug:
            msg: "Deleted {{ deleted_services.results | length }} services from source"

    # =========================================================================
    # PHASE 10: Summary
    # =========================================================================
    - name: "Move Summary"
      ansible.builtin.debug:
        msg: |
          ╔══════════════════════════════════════════════════════════════════╗
          ║                       MOVE COMPLETE                              ║
          ╠══════════════════════════════════════════════════════════════════╣
          ║                                                                  ║
          ║  Source: {{ source_project }}/{{ source_env }}
          ║  Target: {{ target_project }}/{{ target_env }}
          ║  Mode: {{ 'DRY RUN (no changes made)' if dry_run | bool else 'LIVE' }}
          ║                                                                  ║
          ║  Services moved: {{ services_to_move | length if not (dry_run | bool) else 0 }}
          ║  Services skipped (conflict): {{ services_conflict | length }}
          ║  Env vars copied: {{ 'yes' if (move_envs | bool) and not (dry_run | bool) else 'no' }}
          ║  Source deleted: {{ 'no' if (keep_source | bool) or (dry_run | bool) else 'yes' }}
          ║                                                                  ║
          {% if dry_run | bool %}
          ║  Run without -e dry_run=true to apply changes                    ║
          {% endif %}
          ╚══════════════════════════════════════════════════════════════════╝
