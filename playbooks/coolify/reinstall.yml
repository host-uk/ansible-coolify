---
- name: Prepare local environment
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Ensure ssh-agent is running
      ansible.builtin.shell: |
        if ! pgrep -u "{{ lookup('env', 'USER') }}" ssh-agent > /dev/null; then
          ssh-agent -s
        fi
      register: ssh_agent_setup
      changed_when: "'Agent pid' in ssh_agent_setup.stdout"

- name: Full Coolify Re-installation (Backup -> Uninstall -> Install -> Restore)
  hosts: controller
  become: true
  become_user: root
  gather_facts: true
  vars:
    # Disable server registration during reinstall as it's handled by DB restore
    coolify_register_server: false

  tasks:
    - name: Perform Backup
      ansible.builtin.include_role:
        name: coolify
        tasks_from: backup.yml
      when: ansible_os_family == 'Debian'

    - name: Perform Uninstall
      ansible.builtin.include_role:
        name: coolify
        tasks_from: uninstall.yml
      when: ansible_os_family == 'Debian'

    - name: Perform Fresh Install
      ansible.builtin.include_role:
        name: coolify
      when: ansible_os_family == 'Debian'

    - name: Perform Restore
      ansible.builtin.include_role:
        name: coolify
        tasks_from: restore.yml
      when: ansible_os_family == 'Debian'
