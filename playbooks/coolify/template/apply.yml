---
# Apply Template to Environment
# Creates services from a saved template in target environment
#
# Usage:
#   ansible-playbook playbooks/coolify/template/apply.yml \
#     -e template_name=my-stack -e project=example -e env_name=staging
#
# Options:
#   -e dry_run=true         Show what would be created without making changes
#   -e apply_envs=true      Also apply environment variables (default: false)
#   -e server_uuid=xxx      Override server for new resources

- name: Apply Template to Environment
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    # API settings
    coolify_api_url: "http://172.28.0.10:8000/api/v1"
    coolify_api_token: "cn2oEwlO2atkexV3AwlNYroVwk5IWAJxJ4umultx"

    # Template and target (required via -e)
    template_name: ""
    project: ""
    env_name: ""

    # Options
    dry_run: false
    apply_envs: false

    # Paths
    template_path: "{{ playbook_dir }}/../../../templates"

  tasks:
    # =========================================================================
    # PHASE 1: Validate inputs
    # =========================================================================
    - name: "Validate required parameters"
      ansible.builtin.fail:
        msg: "Required: -e template_name=xxx -e project=yyy -e env_name=zzz"
      when: template_name == "" or project == "" or env_name == ""

    - name: "Check if template exists"
      ansible.builtin.stat:
        path: "{{ template_path }}/{{ template_name }}"
      register: template_dir

    - name: "Fail if template not found"
      ansible.builtin.fail:
        msg: "Template '{{ template_name }}' not found at {{ template_path }}/{{ template_name }}"
      when: not template_dir.stat.exists

    # =========================================================================
    # PHASE 2: Load template
    # =========================================================================
    - name: "Load template metadata"
      ansible.builtin.slurp:
        src: "{{ template_path }}/{{ template_name }}/template.yml"
      register: template_meta_raw

    - name: "Load services definition"
      ansible.builtin.slurp:
        src: "{{ template_path }}/{{ template_name }}/services.yml"
      register: services_def_raw

    - name: "Parse services definition"
      ansible.builtin.set_fact:
        template_services: "{{ (services_def_raw.content | b64decode | from_yaml).services }}"

    - name: "Display template info"
      ansible.builtin.debug:
        msg: |
          Template: {{ template_name }}
          Services: {{ template_services | length }}
          {% for svc in template_services %}
            - {{ svc.service_type }}
          {% endfor %}

    # =========================================================================
    # PHASE 3: Resolve target project and environment
    # =========================================================================
    - name: "Get all projects"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/projects"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: all_projects

    - name: "Find target project"
      ansible.builtin.set_fact:
        target_project: "{{ all_projects.json | selectattr('name', 'equalto', project) | first | default(none) }}"

    - name: "Fail if project not found"
      ansible.builtin.fail:
        msg: "Project '{{ project }}' not found. Create it first."
      when: target_project is none

    - name: "Get project details"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/projects/{{ target_project.uuid }}"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: project_details

    - name: "Find target environment"
      ansible.builtin.set_fact:
        target_env: "{{ project_details.json.environments | selectattr('name', 'equalto', env_name) | first | default(none) }}"

    - name: "Fail if environment not found"
      ansible.builtin.fail:
        msg: "Environment '{{ env_name }}' not found in project '{{ project }}'. Create it first."
      when: target_env is none

    - name: "Get available servers"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/servers"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: all_servers
      when: server_uuid is not defined

    - name: "Use first available server if not specified"
      ansible.builtin.set_fact:
        target_server_uuid: "{{ server_uuid | default(all_servers.json[0].uuid) }}"

    - name: "Display target info"
      ansible.builtin.debug:
        msg: |
          Target:
            Project: {{ project }} ({{ target_project.uuid }})
            Environment: {{ env_name }} ({{ target_env.uuid }})
            Server: {{ target_server_uuid }}

    # =========================================================================
    # PHASE 4: Check existing resources
    # =========================================================================
    - name: "Get existing services in target environment"
      ansible.builtin.uri:
        url: "{{ coolify_api_url }}/services"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
        status_code: 200
      register: all_services

    - name: "Filter existing services by environment"
      ansible.builtin.set_fact:
        existing_service_types: "{{ all_services.json | selectattr('environment_id', 'equalto', target_env.id) | map(attribute='service_type') | list }}"

    - name: "Identify services to create"
      ansible.builtin.set_fact:
        services_to_create: "{{ template_services | rejectattr('service_type', 'in', existing_service_types) | list }}"
        services_already_exist: "{{ template_services | selectattr('service_type', 'in', existing_service_types) | list }}"

    - name: "Display apply plan"
      ansible.builtin.debug:
        msg: |
          ╔══════════════════════════════════════════════════════════════════╗
          ║                        APPLY PLAN                                ║
          ╠══════════════════════════════════════════════════════════════════╣
          ║                                                                  ║
          ║  Template: {{ template_name }}
          ║  Target: {{ project }}/{{ env_name }}
          ║  Mode: {{ 'DRY RUN' if dry_run | bool else 'LIVE' }}
          ║                                                                  ║
          ╠══════════════════════════════════════════════════════════════════╣
          ║                                                                  ║
          ║  TO CREATE: {{ services_to_create | length }}
          {% for svc in services_to_create %}
          ║    + {{ svc.service_type }}
          {% endfor %}
          {% if services_to_create | length == 0 %}
          ║    (none - all services already exist)
          {% endif %}
          ║                                                                  ║
          ║  ALREADY EXISTS: {{ services_already_exist | length }}
          {% for svc in services_already_exist %}
          ║    = {{ svc.service_type }}
          {% endfor %}
          ║                                                                  ║
          ╚══════════════════════════════════════════════════════════════════╝

    # =========================================================================
    # PHASE 5: Create services
    # =========================================================================
    - name: "Create services from template"
      when:
        - services_to_create | length > 0
        - not (dry_run | bool)
      block:
        - name: "Create each service"
          ansible.builtin.uri:
            url: "{{ coolify_api_url }}/services"
            method: POST
            headers:
              Authorization: "Bearer {{ coolify_api_token }}"
              Content-Type: "application/json"
            body_format: json
            body:
              type: "{{ item.service_type }}"
              project_uuid: "{{ target_project.uuid }}"
              server_uuid: "{{ target_server_uuid }}"
              environment_name: "{{ env_name }}"
              description: "{{ item.description | default(omit) }}"
            status_code: [200, 201]
          loop: "{{ services_to_create }}"
          loop_control:
            label: "{{ item.service_type }}"
          register: created_services

        - name: "Display created services"
          ansible.builtin.debug:
            msg: |
              Created {{ created_services.results | length }} services:
              {% for result in created_services.results %}
              {% if result.json is defined %}
                - {{ result.item.service_type }} -> {{ result.json.uuid }}
              {% endif %}
              {% endfor %}

    # =========================================================================
    # PHASE 6: Apply environment variables (optional)
    # =========================================================================
    - name: "Apply environment variables"
      when:
        - apply_envs | bool
        - not (dry_run | bool)
      block:
        - name: "Find env files in template"
          ansible.builtin.find:
            paths: "{{ template_path }}/{{ template_name }}/envs"
            patterns: "*.yml"
          register: env_files

        - name: "Get current services for UUID mapping"
          ansible.builtin.uri:
            url: "{{ coolify_api_url }}/services"
            method: GET
            headers:
              Authorization: "Bearer {{ coolify_api_token }}"
            status_code: 200
          register: current_services
          when: env_files.matched > 0

        - name: "Build service type to UUID mapping"
          ansible.builtin.set_fact:
            service_uuid_map: "{{ dict(current_services.json | selectattr('environment_id', 'equalto', target_env.id) | map(attribute='service_type') | zip(current_services.json | selectattr('environment_id', 'equalto', target_env.id) | map(attribute='uuid'))) }}"
          when: env_files.matched > 0

        - name: "Apply env vars from each file"
          ansible.builtin.include_tasks: apply_envs.yml
          loop: "{{ env_files.files }}"
          loop_control:
            label: "{{ env_file.path | basename }}"
            loop_var: env_file
          when:
            - env_files.matched > 0
            - env_file.path | basename | regex_replace('\\.yml$', '') in service_uuid_map

    # =========================================================================
    # PHASE 7: Summary
    # =========================================================================
    - name: "Apply Summary"
      ansible.builtin.debug:
        msg: |
          ╔══════════════════════════════════════════════════════════════════╗
          ║                      APPLY COMPLETE                              ║
          ╠══════════════════════════════════════════════════════════════════╣
          ║                                                                  ║
          ║  Template: {{ template_name }}
          ║  Target: {{ project }}/{{ env_name }}
          ║  Mode: {{ 'DRY RUN (no changes made)' if dry_run | bool else 'LIVE' }}
          ║                                                                  ║
          ║  Services created: {{ services_to_create | length if not (dry_run | bool) else 0 }}
          ║  Services skipped (existed): {{ services_already_exist | length }}
          ║  Env vars applied: {{ 'yes' if (apply_envs | bool) and not (dry_run | bool) else 'no' }}
          ║                                                                  ║
          {% if dry_run | bool %}
          ║  Run without -e dry_run=true to apply changes                    ║
          {% endif %}
          ╚══════════════════════════════════════════════════════════════════╝
