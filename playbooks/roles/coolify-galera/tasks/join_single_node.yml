---
# Join a single node to the Galera cluster
#
# Required variables:
#   galera_join_node: Node configuration dict

- name: "Join {{ galera_join_node.name }}: Deploy node"
  ansible.builtin.include_tasks: deploy_node.yml
  vars:
    galera_current_node: "{{ galera_join_node }}"
    galera_bootstrap_node: false

- name: "Join {{ galera_join_node.name }}: Wait for service"
  ansible.builtin.uri:
    url: "{{ coolify_api_url }}/services/{{ galera_service_uuids[galera_join_node.name] }}"
    method: GET
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
    status_code: 200
  register: galera_join_status
  until: galera_join_status.json.status | default('') == 'running'
  retries: 30
  delay: 10
  ignore_errors: true

- name: "Join {{ galera_join_node.name }}: Wait for sync"
  ansible.builtin.pause:
    seconds: 20
    prompt: "Waiting for {{ galera_join_node.name }} to sync with cluster..."

- name: "Join {{ galera_join_node.name }}: Display status"
  ansible.builtin.debug:
    msg: |
      Node {{ galera_join_node.name }} joined:
        Status: {{ galera_join_status.json.status | default('unknown') }}
        Service UUID: {{ galera_service_uuids[galera_join_node.name] | default('N/A') }}
