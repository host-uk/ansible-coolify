---
# Deploy a single Galera node via Coolify Services API
#
# Required variables:
#   galera_current_node: dict with name, host, ip, role
#   galera_is_bootstrap: boolean - true for first node
#   coolify_api_token: Coolify API token
#   coolify_api_url: Coolify API base URL

- name: "Get Coolify servers list"
  ansible.builtin.uri:
    url: "{{ coolify_api_url }}/servers"
    method: GET
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
    status_code: 200
  register: galera_servers_list

- name: "Find server UUID for node {{ galera_current_node.host }}"
  ansible.builtin.set_fact:
    galera_server_uuid: >-
      {{
        galera_servers_list.json
        | selectattr('ip', 'equalto', galera_current_node.ip)
        | map(attribute='uuid')
        | first
        | default('')
      }}

- name: "Fail if server not registered in Coolify"
  ansible.builtin.fail:
    msg: |
      Server {{ galera_current_node.host }} ({{ galera_current_node.ip }}) not registered in Coolify.
      Please run the node registration playbook first.
  when: galera_server_uuid == ''

- name: "Get existing projects"
  ansible.builtin.uri:
    url: "{{ coolify_api_url }}/projects"
    method: GET
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
    status_code: 200
  register: galera_projects_list

- name: "Find or create Galera project"
  ansible.builtin.set_fact:
    galera_project_uuid: >-
      {{
        galera_projects_list.json
        | selectattr('name', 'equalto', galera_project_name)
        | map(attribute='uuid')
        | first
        | default('')
      }}

- name: "Create Galera project if not exists"
  ansible.builtin.uri:
    url: "{{ coolify_api_url }}/projects"
    method: POST
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ galera_project_name }}"
      description: "MariaDB Galera Cluster"
    status_code: [200, 201]
  register: galera_project_create
  when: galera_project_uuid == ''

- name: "Set project UUID from creation"
  ansible.builtin.set_fact:
    galera_project_uuid: "{{ galera_project_create.json.uuid }}"
  when: galera_project_uuid == ''

- name: "Generate docker-compose content for node"
  ansible.builtin.set_fact:
    galera_compose_content: "{{ lookup('template', 'galera-compose.yml.j2') }}"
  vars:
    galera_node_name: "{{ galera_current_node.name }}"
    galera_node_ip: "{{ galera_current_node.ip }}"
    galera_is_bootstrap: "{{ galera_bootstrap_node | default(false) }}"

- name: "Display compose content (debug)"
  ansible.builtin.debug:
    msg: "{{ galera_compose_content }}"
    verbosity: 1

- name: "Check if Galera service already exists"
  ansible.builtin.uri:
    url: "{{ coolify_api_url }}/services"
    method: GET
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
    status_code: 200
  register: galera_existing_services

- name: "Find existing service for this node"
  ansible.builtin.set_fact:
    galera_existing_service: >-
      {{
        galera_existing_services.json
        | selectattr('name', 'equalto', galera_current_node.name)
        | first
        | default({})
      }}

- name: "Deploy Galera node as Coolify service"
  ansible.builtin.uri:
    url: "{{ coolify_api_url }}/services"
    method: POST
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ galera_current_node.name }}"
      description: "Galera {{ galera_current_node.role }} node on {{ galera_current_node.host }}"
      project_uuid: "{{ galera_project_uuid }}"
      server_uuid: "{{ galera_server_uuid }}"
      environment_name: "{{ galera_environment_name }}"
      type: "docker-compose-empty"
      docker_compose_raw: "{{ galera_compose_content | b64encode }}"
      instant_deploy: "{{ galera_instant_deploy }}"
    status_code: [200, 201]
  register: galera_service_create
  when: galera_existing_service == {}

- name: "Store service UUID"
  ansible.builtin.set_fact:
    galera_service_uuids: >-
      {{
        galera_service_uuids | default({})
        | combine({galera_current_node.name: galera_service_create.json.uuid | default(galera_existing_service.uuid | default(''))})
      }}

- name: "Display deployment result"
  ansible.builtin.debug:
    msg: |
      Galera node {{ galera_current_node.name }} deployment:
        Host: {{ galera_current_node.host }}
        IP: {{ galera_current_node.ip }}
        Role: {{ galera_current_node.role }}
        Server UUID: {{ galera_server_uuid }}
        Service UUID: {{ galera_service_uuids[galera_current_node.name] | default('N/A') }}
        Bootstrap: {{ galera_bootstrap_node | default(false) }}
        Status: {{ 'CREATED' if galera_existing_service == {} else 'ALREADY EXISTS' }}
