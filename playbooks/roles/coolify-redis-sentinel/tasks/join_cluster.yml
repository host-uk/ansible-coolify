---
# Join replica/sentinel nodes to the Redis Sentinel cluster
# Must be run after bootstrap_cluster.yml
#
# Required variables:
#   redis_nodes: List of all cluster nodes
#   redis_master_ip: IP of the master node (set by bootstrap)
#   coolify_api_token: Coolify API token
#   coolify_api_url: Coolify API base URL

- name: "Identify non-master nodes"
  ansible.builtin.set_fact:
    redis_replica_nodes: "{{ redis_nodes | rejectattr('role', 'equalto', 'master') | list }}"

- name: "Deploy replica and sentinel nodes"
  ansible.builtin.include_tasks: deploy_node.yml
  vars:
    redis_current_node: "{{ item }}"
  loop: "{{ redis_replica_nodes }}"
  loop_control:
    label: "{{ item.name }} ({{ item.role }})"

- name: "Wait for all replica services to be deployed"
  ansible.builtin.uri:
    url: "{{ coolify_api_url }}/services/{{ redis_service_uuids[item.name] }}"
    method: GET
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
    status_code: 200
  register: redis_replica_status
  retries: 30
  delay: 10
  until: >
    redis_replica_status.json.status is defined and
    redis_replica_status.json.status in ['running', 'healthy']
  loop: "{{ redis_replica_nodes }}"
  loop_control:
    label: "{{ item.name }}"
  when: redis_service_uuids[item.name] is defined

- name: "Display cluster join summary"
  ansible.builtin.debug:
    msg: |
      Redis Sentinel Cluster Join Complete:
        Master: {{ redis_master_node.name }} ({{ redis_master_ip }})
        Replicas joined:
      {% for node in redis_replica_nodes %}
          - {{ node.name }} ({{ node.ip }}) - {{ node.role }}
      {% endfor %}
        Total nodes: {{ redis_nodes | length }}
