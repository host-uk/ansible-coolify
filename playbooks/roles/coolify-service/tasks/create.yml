---
- name: Create Service
  ansible.builtin.uri:
    url: "{{ coolify_api_base_url }}/services"
    method: POST
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      type: "{{ coolify_service_type | default(omit, true) }}"
      project_uuid: "{{ coolify_service_project_uuid }}"
      server_uuid: "{{ coolify_service_server_uuid }}"
      environment_name: "{{ coolify_service_environment_name | default(omit, true) }}"
      environment_uuid: "{{ coolify_service_environment_uuid | default(omit, true) }}"
      destination_uuid: "{{ coolify_service_destination_uuid | default(omit, true) }}"
      name: "{{ coolify_service_name | default(omit, true) }}"
      description: "{{ coolify_service_description | default(omit, true) }}"
      instant_deploy: "{{ coolify_service_instant_deploy }}"
      docker_compose_raw: "{{ (coolify_service_docker_compose_raw | b64encode) if (coolify_service_docker_compose_raw | default('', true) | length > 0) else omit }}"
    status_code: [200, 201]
  register: create_service_result

- name: Set Service UUID fact
  ansible.builtin.set_fact:
    coolify_service_uuid: "{{ create_service_result.json.uuid }}"

- name: Update Service Name and Configuration (Ensure correctness)
  ansible.builtin.uri:
    url: "{{ coolify_api_base_url }}/services/{{ coolify_service_uuid }}"
    method: PATCH
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ coolify_service_name | default(omit, true) }}"
      description: "{{ coolify_service_description | default(omit, true) }}"
      docker_compose_raw: "{{ (coolify_service_docker_compose_raw | b64encode) if (coolify_service_docker_compose_raw | default('', true) | length > 0) else omit }}"
    status_code: [200, 201]
  when: coolify_service_uuid is defined and coolify_service_uuid != ""

- name: Get Existing Service Environment Variables
  ansible.builtin.uri:
    url: "{{ coolify_api_base_url }}/services/{{ coolify_service_uuid }}/envs"
    method: GET
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
    status_code: [200]
  register: existing_service_envs
  when: coolify_service_uuid is defined and coolify_service_uuid != ""

- name: Add Service Environment Variables (New)
  ansible.builtin.uri:
    url: "{{ coolify_api_base_url }}/services/{{ coolify_service_uuid }}/envs"
    method: POST
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      key: "{{ item.key }}"
      value: "{{ item.value }}"
      is_preview: "{{ item.is_preview | default(false) }}"
      is_literal: "{{ item.is_literal | default(false) }}"
      is_multiline: "{{ item.is_multiline | default(false) }}"
      is_shown_once: "{{ item.is_shown_once | default(false) }}"
    status_code: [200, 201]
  loop: "{{ coolify_service_envs | default([]) }}"
  when: 
    - coolify_service_uuid is defined and coolify_service_uuid != ""
    - existing_service_envs.json is defined
    - item.key not in (existing_service_envs.json | map(attribute='key') | list)

- name: Update Service Environment Variables (Existing)
  ansible.builtin.uri:
    url: "{{ coolify_api_base_url }}/services/{{ coolify_service_uuid }}/envs"
    method: PATCH
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      key: "{{ item.key }}"
      value: "{{ item.value }}"
      is_preview: "{{ item.is_preview | default(false) }}"
      is_literal: "{{ item.is_literal | default(false) }}"
      is_multiline: "{{ item.is_multiline | default(false) }}"
      is_shown_once: "{{ item.is_shown_once | default(false) }}"
    status_code: [200, 201]
  loop: "{{ coolify_service_envs | default([]) }}"
  when: 
    - coolify_service_uuid is defined and coolify_service_uuid != ""
    - existing_service_envs.json is defined
    - item.key in (existing_service_envs.json | map(attribute='key') | list)
