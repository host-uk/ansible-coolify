---
- name: Early Coolify Initialization (BETA)
  ansible.builtin.shell: |
    docker exec coolify php artisan tinker --execute='
    try {
        // Ensure host.docker.internal exists in DB
        $server = \Illuminate\Support\Facades\DB::table("servers")
            ->where("ip", "host.docker.internal")
            ->orWhere("ip", "127.0.0.1")
            ->orWhere("name", "localhost")
            ->first();

        if ($server) {
             \Illuminate\Support\Facades\DB::table("servers")->where("id", $server->id)->update([
                 "name" => "host.docker.internal",
                 "ip" => "host.docker.internal"
             ]);
             
             // Try to update the associated private key name too
             if (isset($server->private_key_id)) {
                 \Illuminate\Support\Facades\DB::table("private_keys")
                    ->where("id", $server->private_key_id)
                    ->update(["name" => "host.docker.internal"]);
             }
        }

        // Enable API and Finish Onboarding via DB to bypass any model issues with ID 0
        $settings = \Illuminate\Support\Facades\DB::table("instance_settings")->where("id", 0)->first();
        if (!$settings) {
            $settings = \Illuminate\Support\Facades\DB::table("instance_settings")->first();
        }
        
        if ($settings) {
            $allowed_ips = array_filter(explode(",", $settings->allowed_ips ?? ""));
            if (!in_array("127.0.0.1", $allowed_ips)) {
                $allowed_ips[] = "127.0.0.1";
            }
            $public_ip = "{{ ansible_host }}";
            if ($public_ip && !in_array($public_ip, $allowed_ips)) {
                $allowed_ips[] = $public_ip;
            }
            
            \Illuminate\Support\Facades\DB::table("instance_settings")->where("id", $settings->id)->update([
                "is_api_enabled" => true,
                "is_onboarding_finished" => true,
                "allowed_ips" => implode(",", $allowed_ips)
            ]);
            echo "COOLIFY_INITIALIZED\n";
        } else {
             // Fallback to creation if none exists. Try to force ID 0 but be graceful.
             try {
                 \Illuminate\Support\Facades\DB::table("instance_settings")->insert([
                    "id" => 0,
                    "is_api_enabled" => true,
                    "is_onboarding_finished" => true,
                    "allowed_ips" => "127.0.0.1,{{ ansible_host }}"
                 ]);
             } catch (\Exception $e) {
                 \Illuminate\Support\Facades\DB::table("instance_settings")->insert([
                    "is_api_enabled" => true,
                    "is_onboarding_finished" => true,
                    "allowed_ips" => "127.0.0.1,{{ ansible_host }}"
                 ]);
             }
             echo "COOLIFY_INITIALIZED\n";
        }
    } catch (\Exception $e) {
        echo "INIT_ERROR: " . $e->getMessage() . "\n";
        exit(1);
    }
    '
  register: init_result
  changed_when: "'COOLIFY_INITIALIZED' in init_result.stdout"
  when: not ansible_check_mode

- name: Clear Coolify Cache (BETA)
  ansible.builtin.command: "docker exec coolify php artisan {{ item }}"
  loop:
    - optimize:clear
    - config:clear
    - cache:clear
  when: 
    - not ansible_check_mode
    - init_result is success
  changed_when: true

- name: Generate and Configure Coolify SSH Keys (BETA)
  block:
    - name: Ensure Coolify SSH keys directory exists
      ansible.builtin.file:
        path: /data/coolify/ssh/keys
        state: directory
        mode: '0700'
        owner: 9999
        group: 9999

    - name: Check if Coolify identity key exists
      ansible.builtin.stat:
        path: "{{ coolify_identity_key_actual_path }}"
      register: coolify_identity_key

    - name: Generate RSA SSH key pair for Coolify
      ansible.builtin.command:
        cmd: ssh-keygen -t rsa -b 4096 -f /data/coolify/ssh/keys/id.root@host.docker.internal -q -N "" -C root@coolify
      when: 
        - not coolify_identity_key.stat.exists
        - coolify_detected_key_uuid == ""

    - name: Update key path if newly generated
      ansible.builtin.set_fact:
        coolify_identity_key_actual_path: "/data/coolify/ssh/keys/id.root@host.docker.internal"
      when: 
        - not coolify_identity_key.stat.exists
        - coolify_detected_key_uuid == ""

    - name: Check which files exist for ownership (after potential generation)
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - "{{ coolify_identity_key_actual_path }}"
        - "{{ coolify_identity_key_actual_path }}.pub"
        - "{{ coolify_identity_key_actual_path | regex_replace('ssh_key@', '') }}.pub"
      register: key_stats_after_gen

    - name: Set correct ownership for keys
      ansible.builtin.file:
        path: "{{ item.item }}"
        owner: 9999
        group: 9999
        mode: "{{ '0600' if not item.item.endswith('.pub') else '0644' }}"
      loop: "{{ key_stats_after_gen.results }}"
      when: item.stat.exists

    - name: Update key facts if newly generated or path changed
      ansible.builtin.include_tasks: detect_keys.yml
      when: not coolify_identity_key.stat.exists and coolify_detected_key_uuid == ""

- name: Register newly generated key in DB if needed (BETA)
  ansible.builtin.shell: |
    docker exec coolify php artisan tinker --execute='
    try {
        $privateKey = \Illuminate\Support\Facades\DB::table("private_keys")->where("name", "host.docker.internal")->first();
        if (!$privateKey) {
            $id = \Illuminate\Support\Facades\DB::table("private_keys")->insertGetId([
                "name" => "host.docker.internal",
                "description" => "Initial identity key",
                "private_key" => <<<'EOF'
    {{ coolify_priv_key_slurp.content | default('') | b64decode | trim }}
    EOF
            ], "id");
            $privateKeyId = $id;
        } else {
            $privateKeyId = $privateKey->id;
        }
        
        $server = \Illuminate\Support\Facades\DB::table("servers")->where("ip", "host.docker.internal")->first();
        if ($server && $server->private_key_id != $privateKeyId) {
            \Illuminate\Support\Facades\DB::table("servers")->where("id", $server->id)->update([
                "private_key_id" => $privateKeyId
            ]);
        }
    } catch (\Exception $e) {
        echo "ERROR: " . $e->getMessage();
        exit(1);
    }
    '
  when: 
    - not ansible_check_mode
    - coolify_detected_key_uuid == ""

- name: Check if API token is already saved on host
  ansible.builtin.stat:
    path: /data/coolify/ansible-token
  register: token_file_stat

- name: Read saved API token
  ansible.builtin.shell: cat /data/coolify/ansible-token | tr -d '\n' | tr -d '\r' | tr -d '%'
  register: saved_token
  when: token_file_stat.stat.exists
  changed_when: false
  no_log: true

- name: Setup Coolify API and Token (BETA)
  ansible.builtin.shell: |
    docker exec coolify php artisan tinker --execute='
    try {
        $tokenName = "ansible-token";
        $user = \App\Models\User::where("email", "{{ coolify_root_user_email }}")->first();
        if (!$user) {
            $user = \App\Models\User::first();
        }
        
        if (!$user && "{{ coolify_root_user_email }}" != "") {
            $user = \App\Models\User::create([
                "name" => "{{ coolify_root_username }}",
                "email" => "{{ coolify_root_user_email }}",
                "password" => \Illuminate\Support\Facades\Hash::make("{{ coolify_root_user_password }}"),
                "email_verified_at" => now(),
            ]);
        }
        if ($user) {
            // Ensure user is an admin and onboarding is done
            $user->forceFill(["email_verified_at" => now()])->save();
            
            $token = $user->tokens()->where("name", $tokenName)->first();
            if ($token) {
                $token->delete();
            }
            $team = $user->teams()->first();
            if (!$team) {
                $team = \App\Models\Team::create([
                    "name" => $user->name . " Team",
                    "personal_team" => true,
                ]);
                $user->teams()->attach($team->id, ["role" => "admin"]);
            }
            if ($team) {
                $plainToken = \Illuminate\Support\Str::random(40);
                $newToken = new \Laravel\Sanctum\PersonalAccessToken();
                $newToken->name = $tokenName;
                $newToken->token = hash("sha256", $plainToken);
                $newToken->abilities = ["*"];
                $newToken->tokenable_id = $user->id;
                $newToken->tokenable_type = get_class($user);
                $newToken->team_id = $team->id;
                $newToken->save();
                echo $plainToken;
            }
        }
    } catch (\Exception $e) {
        echo "ERROR: " . $e->getMessage();
        exit(1);
    }
    ' | tail -n 1 | tr -d '\n' | tr -d '\r'
  register: api_token_result
  when: not token_file_stat.stat.exists
  changed_when: true
  no_log: true

- name: Save API token to host for reuse
  ansible.builtin.copy:
    content: "{{ api_token_result.stdout | trim }}"
    dest: /data/coolify/ansible-token
    mode: '0600'
  when: 
    - not token_file_stat.stat.exists 
    - api_token_result is defined
    - api_token_result.stdout is defined and api_token_result.stdout != ""
  no_log: true

- name: Initialize API Token fact
  ansible.builtin.set_fact:
    coolify_api_token: ""

- name: Set API Token fact from saved file
  ansible.builtin.set_fact:
    coolify_api_token: "{{ saved_token.stdout | trim }}"
  when: 
    - token_file_stat.stat.exists
    - saved_token.stdout is defined and saved_token.stdout != ""
  no_log: true

- name: Set API Token fact from command result
  ansible.builtin.set_fact:
    coolify_api_token: "{{ api_token_result.stdout | trim }}"
  when: 
    - not token_file_stat.stat.exists
    - api_token_result is defined
    - api_token_result.stdout is defined and api_token_result.stdout != ""
  no_log: true

#- name: Validate API Token (BETA)
#  ansible.builtin.uri:
#    url: "{{ coolify_api_base_url }}/version"
#    method: GET
#    headers:
#      Authorization: "Bearer {{ coolify_api_token }}"
#    status_code: 200
#  register: api_version_check
#  when:
#    - not ansible_check_mode
#    - coolify_api_token != ""
#  ignore_errors: true
#
#- name: Warn if API Token is invalid
#  ansible.builtin.debug:
#    msg: "WARNING: Coolify API validation failed. This usually means the API is disabled or the token is incorrect. You may need to register servers manually in the Coolify UI."
#  when: coolify_api_token == "" or (api_version_check.failed | default(false)) or (api_version_check.status | default(0) != 200)
#
#- name: Set API success fact
#  ansible.builtin.set_fact:
#    coolify_api_ready: "{{ not (api_version_check.failed | default(true)) and (api_version_check.status | default(0) == 200) }}"

