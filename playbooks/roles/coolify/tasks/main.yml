---
- name: Allow incoming UI Port
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
  loop:
    - 6001
    - 6002
    - 8000
  when: 
    - ansible_os_family == 'Debian'
    - common_manage_ufw | default(false) | bool

- name: Ensure host.docker.internal resolves to 127.0.0.1
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.0\.1'
    line: "127.0.0.1 localhost {{ inventory_hostname }} host.docker.internal"
    state: present
    unsafe_writes: true  # Required for Docker containers where /etc/hosts is mounted
  when: ansible_os_family == 'Debian'

- name: Check if Coolify is already installed
  ansible.builtin.stat:
    path: /data/coolify/source/.env
  register: coolify_bin

- name: Validate Admin Password Strength
  ansible.builtin.assert:
    that:
      - coolify_root_user_password | length >= 8
      - coolify_root_user_password is search('[!@#$%^&*(),.?":{}|<>]')
    fail_msg: "Admin password must be at least 8 characters long and contain at least one special character."
  when: 
    - coolify_root_user_password != ""
    - not coolify_bin.stat.exists or coolify_api_token | default("") == ""

- name: Download Coolify installation script
  ansible.builtin.get_url:
    url: "https://cdn.coollabs.io/coolify/install.sh"
    dest: "/root/install.sh"
    mode: "0770"
  when: 
    - not coolify_bin.stat.exists
    - ansible_os_family == 'Debian'

- name: Execute Coolify installation script
  ansible.builtin.command: "/root/install.sh"
  environment:
#    ROOT_USERNAME: "{{ coolify_root_username }}"
#    ROOT_USER_EMAIL: "{{ coolify_root_user_email }}"
#    ROOT_USER_PASSWORD: "{{ coolify_root_user_password }}"
    DOCKER_ADDRESS_POOL_BASE: "{{ coolify_docker_address_pool_base }}"
    DOCKER_ADDRESS_POOL_SIZE: "{{ coolify_docker_address_pool_size | string }}"
    DOCKER_POOL_FORCE_OVERRIDE: "{{ coolify_docker_pool_force_override | string | lower }}"
    AUTOUPDATE: "{{ coolify_autoupdate | string | lower }}"
    REGISTRY_URL: "{{ coolify_registry_url }}"
  register: install_result
  changed_when: "'Installation completed' in install_result.stdout"
  when: 
    - not coolify_bin.stat.exists
    - ansible_os_family == 'Debian'

- name: Debug installation script output
  ansible.builtin.debug:
    var: install_result.stdout_lines
  when: 
    - not coolify_bin.stat.exists
    - ansible_os_family == 'Debian'
    - install_result is defined


- name: Ensure Coolify .env exists for backup
  ansible.builtin.stat:
    path: /data/coolify/source/.env
  register: coolify_env_file

- name: Backup Coolify .env file to local machine
  ansible.builtin.fetch:
    src: /data/coolify/source/.env
    dest: "{{ coolify_state_path }}/{{ inventory_hostname }}/backups/coolify/.env"
    flat: true
  when: 
    - ansible_os_family == 'Debian'
    - coolify_env_file.stat.exists

- name: Backup Coolify SSH keys to local machine
  block:
    - name: Archive Coolify SSH keys
      ansible.builtin.shell: |
        tar -czf /tmp/coolify_ssh_keys.tar.gz -C /data/coolify/ssh/keys .
      changed_when: true
      register: ssh_keys_archive
      ignore_errors: true

    - name: Fetch Coolify SSH keys archive
      ansible.builtin.fetch:
        src: /tmp/coolify_ssh_keys.tar.gz
        dest: "{{ coolify_state_path }}/{{ inventory_hostname }}/backups/coolify/coolify_ssh_keys.tar.gz"
        flat: true
      when: ssh_keys_archive is success

    - name: Remove temporary archive
      ansible.builtin.file:
        path: /tmp/coolify_ssh_keys.tar.gz
        state: absent
  when:
    - ansible_os_family == 'Debian'
    - coolify_env_file.stat.exists

# Automatic API and key setup for node registration
- name: Setup Coolify API and Keys
  when:
    - ansible_os_family == 'Debian'
    - coolify_auto_setup_enabled | default(true) | bool
  block:
    - name: Detect existing Coolify keys
      ansible.builtin.include_tasks: detect_keys.yml

    - name: Setup Coolify API and create token
      ansible.builtin.include_tasks: api_setup.yml

    - name: Setup host.docker.internal key
      ansible.builtin.include_tasks: key_setup.yml
      vars:
        coolify_key_name: "host.docker.internal"
        coolify_save_to_state: true

    - name: Generate onboarding URL and finalize setup
      ansible.builtin.include_tasks: onboarding_url.yml

