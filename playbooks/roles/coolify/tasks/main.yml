---
- name: Allow incoming UI Port
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
  loop:
    - 6001
    - 6002
    - 8000
  when: 
    - ansible_os_family == 'Debian'
    - common_manage_ufw | default(false) | bool

- name: Check if Coolify is already installed
  ansible.builtin.stat:
    path: /data/coolify/source/.env
  register: coolify_bin

- name: Validate Admin Password Strength
  ansible.builtin.assert:
    that:
      - coolify_root_user_password | length >= 8
      - coolify_root_user_password is search('[!@#$%^&*(),.?":{}|<>]')
    fail_msg: "Admin password must be at least 8 characters long and contain at least one special character."
  when: 
    - coolify_root_user_password != ""
    - not coolify_bin.stat.exists or coolify_api_token | default("") == ""

- name: Download Coolify installation script
  ansible.builtin.get_url:
    url: "https://cdn.coollabs.io/coolify/install.sh"
    dest: "/root/install.sh"
    mode: "0770"
  when: 
    - not coolify_bin.stat.exists
    - ansible_os_family == 'Debian'

- name: Execute Coolify installation script
  ansible.builtin.command: "/root/install.sh"
  environment:
    ROOT_USERNAME: "{{ coolify_root_username }}"
    ROOT_USER_EMAIL: "{{ coolify_root_user_email }}"
    ROOT_USER_PASSWORD: "{{ coolify_root_user_password }}"
    DOCKER_ADDRESS_POOL_BASE: "{{ coolify_docker_address_pool_base }}"
    DOCKER_ADDRESS_POOL_SIZE: "{{ coolify_docker_address_pool_size | string }}"
    DOCKER_POOL_FORCE_OVERRIDE: "{{ coolify_docker_pool_force_override | string | lower }}"
    AUTOUPDATE: "{{ coolify_autoupdate | string | lower }}"
    REGISTRY_URL: "{{ coolify_registry_url }}"
  register: install_result
  changed_when: "'Installation completed' in install_result.stdout"
  when: 
    - not coolify_bin.stat.exists
    - ansible_os_family == 'Debian'

- name: Debug installation script output
  ansible.builtin.debug:
    var: install_result.stdout_lines
  when: 
    - not coolify_bin.stat.exists
    - ansible_os_family == 'Debian'
    - install_result is defined


- name: Ensure Coolify .env exists for backup
  ansible.builtin.stat:
    path: /data/coolify/source/.env
  register: coolify_env_file

- name: Backup Coolify .env file to local machine
  ansible.builtin.fetch:
    src: /data/coolify/source/.env
    dest: "{{ coolify_state_path }}/{{ inventory_hostname }}/backups/coolify/.env"
    flat: true
  when: 
    - ansible_os_family == 'Debian'
    - coolify_env_file.stat.exists

- name: Configure Coolify Application S3 Storage in .env
  ansible.builtin.lineinfile:
    path: /data/coolify/source/.env
    regexp: "^{{ item.key }}="
    line: "{{ item.key }}={{ item.value }}"
    state: present
  loop:
    - { key: 'S3_ENABLED', value: "{{ s3_enabled | string | lower }}" }
    - { key: 'S3_ENDPOINT', value: "{{ s3_endpoint }}" }
    - { key: 'S3_REGION', value: "{{ s3_region }}" }
    - { key: 'S3_BUCKET', value: "{{ s3_bucket }}" }
    - { key: 'S3_ACCESS_KEY', value: "{{ lookup('env', 'HETZNER_S3_APP_ACCESS_KEY') | default(s3_access_key) }}" }
    - { key: 'S3_SECRET_KEY', value: "{{ lookup('env', 'HETZNER_S3_APP_SECRET_KEY') | default(s3_secret_key) }}" }
  when: 
    - ansible_os_family == 'Debian'
    - coolify_env_file.stat.exists
    - s3_enabled | bool
  no_log: true

- name: Setup Coolify API (BETA)
  ansible.builtin.include_tasks: api_setup.yml
  when: coolify_auto_setup_enabled | default(false) | bool

- name: Setup Private Key (BETA)
  ansible.builtin.include_tasks: key_setup.yml
  vars:
    coolify_key_name: "host.docker.internal"
    coolify_save_to_state: true
  when: 
    - coolify_auto_setup_enabled | default(false) | bool
    - "'production' not in group_names"
    - coolify_api_ready | default(false) | bool

- name: Register All Nodes (BETA)
  ansible.builtin.include_tasks: register_all_nodes.yml
  when: 
    - coolify_auto_setup_enabled | default(false) | bool
    - coolify_api_ready | default(false) | bool

- name: Manage Coolify Host SSH Key
  block:
    - name: Fetch Coolify Public Key from Controller
      ansible.builtin.slurp:
        src: /data/coolify/ssh/keys/id.root@host.docker.internal.pub
      register: coolify_generated_pub_key
      ignore_errors: true

    - name: Distribute Coolify Public Key to All Servers
      ansible.posix.authorized_key:
        user: root
        state: present
        key: "{{ coolify_generated_pub_key.content | b64decode }}"
      delegate_to: "{{ item }}"
      loop: "{{ groups['production'] | default([]) + groups['development'] | default([]) }}"
      when: 
        - coolify_generated_pub_key is success
        - coolify_generated_pub_key.content is defined
      run_once: true
  when: 
    - coolify_auto_setup_enabled | default(false) | bool
