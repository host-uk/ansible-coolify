---
- name: Configure Coolify Application S3 Storage in .env
  ansible.builtin.lineinfile:
    path: /data/coolify/source/.env
    regexp: "^{{ item.key }}="
    line: "{{ item.key }}={{ item.value }}"
    state: present
  loop:
    - { key: 'S3_ENABLED', value: "{{ s3_enabled | string | lower }}" }
    - { key: 'S3_ENDPOINT', value: "{{ s3_endpoint }}" }
    - { key: 'S3_REGION', value: "{{ s3_region }}" }
    - { key: 'S3_BUCKET', value: "{{ s3_bucket }}" }
    - { key: 'S3_ACCESS_KEY', value: "{{ lookup('env', 'HETZNER_S3_APP_ACCESS_KEY') | default(s3_access_key) }}" }
    - { key: 'S3_SECRET_KEY', value: "{{ lookup('env', 'HETZNER_S3_APP_SECRET_KEY') | default(s3_secret_key) }}" }
  when: 
    - ansible_os_family == 'Debian'
    - s3_enabled | bool
  no_log: true
