---
- name: Register Node in Coolify - {{ node_name }}
  block:
    - name: Set node facts
      ansible.builtin.set_fact:
        current_node_hostname: "{{ hostvars[node_name]['ansible_hostname'] | default(node_name) }}"
        current_node_ip: "{{ hostvars[node_name]['private_ip'] | default(hostvars[node_name]['ansible_host'], true) | default(node_name, true) }}"
        current_node_key_path: "{{ hostvars[node_name]['ansible_ssh_private_key_file'] | default(coolify_private_key_path) }}"

    - name: Skip registration if this is the controller (localhost/host.docker.internal)
      ansible.builtin.meta: noop
      when: current_node_ip == '127.0.0.1' or current_node_hostname == 'host.docker.internal' or node_name == inventory_hostname

    - name: Ensure key is registered in Coolify for {{ node_name }}
      ansible.builtin.include_tasks: key_setup.yml
      vars:
        coolify_key_name: "{{ node_name }}"
        coolify_private_key_path: "{{ current_node_key_path }}"
        coolify_save_to_state: true
      when: not (current_node_ip == '127.0.0.1' or current_node_hostname == 'host.docker.internal' or node_name == inventory_hostname)

    - name: Add Node IP to Coolify Allowed IPs
      ansible.builtin.shell: |
        docker exec coolify php artisan tinker --execute='
        try {
            $settings = \App\Models\InstanceSettings::first();
            if ($settings) {
                $ips = array_filter(explode(",", $settings->allowed_ips ?? ""));
                if (!in_array("{{ current_node_ip }}", $ips)) {
                    $ips[] = "{{ current_node_ip }}";
                    $settings->allowed_ips = implode(",", $ips);
                    $settings->save();
                    echo "IP_ADDED";
                } else {
                    echo "IP_ALREADY_EXISTS";
                }
            }
        } catch (\Exception $e) {
            echo "IP_ADD_ERROR: " . $e->getMessage();
        }
        '
      register: ip_add_result
      changed_when: "'IP_ADDED' in ip_add_result.stdout"
      when: 
        - not ansible_check_mode
        - not (current_node_ip == '127.0.0.1' or current_node_hostname == 'host.docker.internal' or node_name == inventory_hostname)
      no_log: true

    - name: Add Coolify public key to node authorized_keys
      ansible.posix.authorized_key:
        user: root
        state: present
        key: "{{ coolify_public_key }}"
      delegate_to: "{{ node_name }}"
      when:
        - not ansible_check_mode
        - coolify_public_key is defined
        - coolify_public_key != ""
        - not (current_node_ip == '127.0.0.1' or current_node_hostname == 'host.docker.internal' or node_name == inventory_hostname)

    - name: Get current servers from Coolify
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/servers"
        method: GET
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
      register: servers_list
      when: 
        - not ansible_check_mode
        - coolify_api_token | default('') != ''
        - not (current_node_ip == '127.0.0.1' or current_node_hostname == 'host.docker.internal' or node_name == inventory_hostname)
      ignore_errors: true

    - name: Post server registration to Coolify
      ansible.builtin.uri:
        url: "{{ coolify_api_base_url }}/servers"
        method: POST
        headers:
          Authorization: "Bearer {{ coolify_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "{{ current_node_hostname }}"
          description: "Registered via Ansible"
          ip: "{{ current_node_ip }}"
          port: 22
          user: "root"
          private_key_uuid: "{{ coolify_key_uuid }}"
          is_build_server: "{{ 'builder' in hostvars[node_name].labels | default([]) }}"
          instant_validate: false
          proxy_type: "traefik"
        status_code: [200, 201]
      when: 
        - not ansible_check_mode
        - coolify_api_token | default('') != ''
        - servers_list is success
        - servers_list.json is defined
        - servers_list.json | type_debug == 'list'
        - servers_list.json | selectattr('name', 'equalto', current_node_hostname) | list | length == 0
        - not (current_node_ip == '127.0.0.1' or current_node_hostname == 'host.docker.internal' or node_name == inventory_hostname)
