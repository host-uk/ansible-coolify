---
- name: Ensure backup directory exists on local machine
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0700'
  loop:
    - "{{ coolify_state_path }}/{{ inventory_hostname }}/backups/coolify"
    - "{{ coolify_state_path }}/{{ inventory_hostname }}/.ssh"
  delegate_to: localhost
  become: false

#- name: Setup API for backup trigger
#  ansible.builtin.include_tasks: api_setup.yml
#  when: "'controller' in group_names"

- name: Trigger manual schedule run on controller
  ansible.builtin.command: docker exec coolify php artisan schedule:run-manual
  register: schedule_run
  changed_when: true
  when: "'controller' in group_names"

- name: Wait for backup completion
  ansible.builtin.pause:
    seconds: 2
  when: "'controller' in group_names"

- name: Get latest backup info via Tinker
  ansible.builtin.shell: |
    set -o pipefail
    docker exec coolify php artisan tinker --execute='
    $execution = \Illuminate\Support\Facades\DB::table("scheduled_database_backup_executions")
        ->latest()
        ->first();
    if ($execution) {
        echo json_encode($execution);
    } else {
        echo "null";
    }
    '
  register: tinker_backup_info
  changed_when: false
  until: 
    - tinker_backup_info.stdout != "null"
    - (tinker_backup_info.stdout | from_json).status == 'success'
  retries: 10
  delay: 5
  when: 
    - "'controller' in group_names"
  ignore_errors: true

- name: Debug Backup Info
  ansible.builtin.debug:
    var: tinker_backup_info.stdout
  when: 
    - "'controller' in group_names"
    - tinker_backup_info.stdout is defined

- name: Find latest Coolify instance backup file
  ansible.builtin.find:
    paths: /data/coolify/backups/instance
    patterns: "*.tar.gz"
    recurse: false
  register: coolify_instance_backups
  when: "'controller' in group_names"

- name: Fetch Coolify instance backup
  ansible.builtin.fetch:
    src: "{{ (coolify_instance_backups.files | sort(attribute='mtime', reverse=true) | first).path }}"
    dest: "{{ coolify_state_path }}/{{ inventory_hostname }}/backups/coolify/"
    flat: true
  when: 
    - "'controller' in group_names"
    - coolify_instance_backups.matched > 0
  failed_when: false

- name: Get APP_KEY from .env
  ansible.builtin.shell: |
    set -o pipefail
    grep '^APP_KEY=' /data/coolify/source/.env | cut -d'=' -f2-
  register: app_key_raw
  changed_when: false

- name: Save APP_KEY for later
  ansible.builtin.copy:
    content: "{{ app_key_raw.stdout }}"
    dest: "{{ coolify_state_path }}/{{ inventory_hostname }}/backups/coolify/APP_KEY"
    mode: '0600'
  delegate_to: localhost
  become: false

- name: Create database dump
  ansible.builtin.shell: |
    docker exec coolify-db pg_dump -U coolify -d coolify -Fc > /tmp/coolify_db.dump
  register: db_dump
  changed_when: true

- name: Fetch database dump
  ansible.builtin.fetch:
    src: /tmp/coolify_db.dump
    dest: "{{ coolify_state_path }}/{{ inventory_hostname }}/backups/coolify/coolify_db.dump"
    flat: true

- name: Archive SSH keys
  ansible.builtin.shell: |
    cd /data/coolify/ssh/keys && tar -czf /tmp/coolify_ssh_keys.tar.gz .
  register: ssh_keys_archive
  changed_when: true

- name: Fetch SSH keys archive
  ansible.builtin.fetch:
    src: /tmp/coolify_ssh_keys.tar.gz
    dest: "{{ coolify_state_path }}/{{ inventory_hostname }}/backups/coolify/coolify_ssh_keys.tar.gz"
    flat: true

- name: List Private Keys from Coolify for backup
  ansible.builtin.uri:
    url: "{{ coolify_api_base_url }}/security/keys"
    method: GET
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
  register: backup_keys_list
  when: 
    - "'controller' in group_names"
    - not ansible_check_mode
    - coolify_api_ready | default(false) | bool
    - coolify_api_token | default('') != ''
  ignore_errors: true

- name: Save Coolify public keys to local backup
  ansible.builtin.copy:
    content: "{{ item.public_key }}"
    dest: "{{ coolify_state_path }}/{{ inventory_hostname }}/backups/coolify/{{ item.name }}.pub"
    mode: '0644'
  loop: "{{ backup_keys_list.json | default([]) }}"
  delegate_to: localhost
  become: false
  when:
    - "'controller' in group_names"
    - not ansible_check_mode
    - backup_keys_list is defined and backup_keys_list.json is defined
    - item.public_key is defined
    - item.public_key != ""

- name: Find host SSH keys (public and private)
  ansible.builtin.find:
    paths: 
      - /root/.ssh
      - /etc/ssh
    patterns: 
      - "ssh_host_*"
      - "id_*"
  register: host_ssh_keys
  when: "'controller' in group_names"

- name: Fetch host SSH keys
  ansible.builtin.fetch:
    src: "{{ item.path }}"
    dest: "{{ coolify_state_path }}/{{ inventory_hostname }}/.ssh/"
    flat: true
  loop: "{{ host_ssh_keys.files | default([]) }}"
  when: 
    - "'controller' in group_names"
    - host_ssh_keys is defined and host_ssh_keys.matched > 0

- name: Remove temporary files on remote
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/coolify_db.dump
    - /tmp/coolify_ssh_keys.tar.gz

- name: Perform S3 Remote Backup
  ansible.builtin.include_tasks: s3_backup.yml
  when: s3_enabled | bool
