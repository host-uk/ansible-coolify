---
- name: Create Database
  ansible.builtin.uri:
    url: "{{ coolify_api_base_url }}/databases/{{ coolify_database_type }}"
    method: POST
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
      Content-Type: "application/json"
    body_format: json
    # Filter out null values and the omit placeholder from the body
    body: "{{ coolify_database_body | dict2items | rejectattr('value', 'undefined') | rejectattr('value', 'none') | list | items2dict }}"
    status_code: [200, 201]
  register: create_database_result

- name: Set Database UUID fact
  ansible.builtin.set_fact:
    coolify_database_uuid: "{{ create_database_result.json.uuid if (create_database_result.json is defined and create_database_result.json.uuid is defined) else '' }}"

- name: Update Database Name and Configuration (Ensure correctness)
  ansible.builtin.uri:
    url: "{{ coolify_api_base_url }}/databases/{{ coolify_database_uuid }}"
    method: PATCH
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body: "{{ patch_body | dict2items | rejectattr('value', 'undefined') | rejectattr('value', 'none') | list | items2dict }}"
    status_code: [200, 201]
  vars:
    patch_body:
      name: "{{ coolify_database_body.name | default(none, true) }}"
      description: "{{ coolify_database_body.description | default(none, true) }}"
      is_public: "{{ coolify_database_body.is_public | default(none) }}"
      public_port: "{{ coolify_database_body.public_port | default(none) }}"
      ports_mappings: "{{ coolify_database_body.ports_mappings | default(none, true) }}"
  when: coolify_database_uuid is defined and coolify_database_uuid != ""
