---
# Deploy a single PostgreSQL Patroni node via Coolify Services API
#
# Required variables:
#   postgresql_current_node: dict with name, host, ip, role
#   coolify_api_token: Coolify API token
#   coolify_api_url: Coolify API base URL

- name: "Get Coolify servers list"
  ansible.builtin.uri:
    url: "{{ coolify_api_url }}/servers"
    method: GET
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
    status_code: 200
  register: postgresql_servers_list

- name: "Find server UUID for node {{ postgresql_current_node.host }}"
  ansible.builtin.set_fact:
    postgresql_server_uuid: >-
      {{
        postgresql_servers_list.json
        | selectattr('ip', 'equalto', postgresql_current_node.ip)
        | map(attribute='uuid')
        | first
        | default('')
      }}

- name: "Fail if server not registered in Coolify"
  ansible.builtin.fail:
    msg: |
      Server {{ postgresql_current_node.host }} ({{ postgresql_current_node.ip }}) not registered in Coolify.
      Please run the node registration playbook first.
  when: postgresql_server_uuid == ''

- name: "Get existing projects"
  ansible.builtin.uri:
    url: "{{ coolify_api_url }}/projects"
    method: GET
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
    status_code: 200
  register: postgresql_projects_list

- name: "Find or create PostgreSQL project"
  ansible.builtin.set_fact:
    postgresql_project_uuid: >-
      {{
        postgresql_projects_list.json
        | selectattr('name', 'equalto', postgresql_project_name)
        | map(attribute='uuid')
        | first
        | default('')
      }}

- name: "Create PostgreSQL project if not exists"
  ansible.builtin.uri:
    url: "{{ coolify_api_url }}/projects"
    method: POST
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ postgresql_project_name }}"
      description: "PostgreSQL Patroni High-Availability Cluster"
    status_code: [200, 201]
  register: postgresql_project_create
  when: postgresql_project_uuid == ''

- name: "Set project UUID from creation"
  ansible.builtin.set_fact:
    postgresql_project_uuid: "{{ postgresql_project_create.json.uuid }}"
  when: postgresql_project_uuid == ''

- name: "Determine node role settings"
  ansible.builtin.set_fact:
    postgresql_is_primary: "{{ postgresql_current_node.role == 'primary' }}"
    postgresql_node_name: "{{ postgresql_current_node.name }}"
    postgresql_node_ip: "{{ postgresql_current_node.ip }}"

- name: "Generate Patroni configuration"
  ansible.builtin.set_fact:
    patroni_config: "{{ lookup('template', 'patroni.yml.j2') }}"

- name: "Generate docker-compose content for node"
  ansible.builtin.set_fact:
    postgresql_compose_content: "{{ lookup('template', 'patroni-compose.yml.j2') }}"

- name: "Display compose content (debug)"
  ansible.builtin.debug:
    msg: "{{ postgresql_compose_content }}"
    verbosity: 1

- name: "Check if PostgreSQL service already exists"
  ansible.builtin.uri:
    url: "{{ coolify_api_url }}/services"
    method: GET
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
    status_code: 200
  register: postgresql_existing_services

- name: "Find existing service for this node"
  ansible.builtin.set_fact:
    postgresql_existing_service: >-
      {{
        postgresql_existing_services.json
        | selectattr('name', 'equalto', postgresql_current_node.name)
        | first
        | default({})
      }}

- name: "Deploy PostgreSQL node as Coolify service"
  ansible.builtin.uri:
    url: "{{ coolify_api_url }}/services"
    method: POST
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ postgresql_current_node.name }}"
      description: "PostgreSQL Patroni {{ postgresql_current_node.role }} on {{ postgresql_current_node.host }}"
      project_uuid: "{{ postgresql_project_uuid }}"
      server_uuid: "{{ postgresql_server_uuid }}"
      environment_name: "{{ postgresql_environment_name }}"
      type: "docker-compose-empty"
      docker_compose_raw: "{{ postgresql_compose_content | b64encode }}"
      instant_deploy: "{{ postgresql_instant_deploy }}"
    status_code: [200, 201]
  register: postgresql_service_create
  when: postgresql_existing_service == {}

- name: "Store service UUID"
  ansible.builtin.set_fact:
    postgresql_service_uuids: >-
      {{
        postgresql_service_uuids | default({})
        | combine({postgresql_current_node.name: postgresql_service_create.json.uuid | default(postgresql_existing_service.uuid | default(''))})
      }}

- name: "Display deployment result"
  ansible.builtin.debug:
    msg: |
      PostgreSQL Patroni node {{ postgresql_current_node.name }} deployment:
        Host: {{ postgresql_current_node.host }}
        IP: {{ postgresql_current_node.ip }}
        Role: {{ postgresql_current_node.role }}
        Server UUID: {{ postgresql_server_uuid }}
        Service UUID: {{ postgresql_service_uuids[postgresql_current_node.name] | default('N/A') }}
        Is Primary: {{ postgresql_is_primary }}
        Status: {{ 'CREATED' if postgresql_existing_service == {} else 'ALREADY EXISTS' }}
