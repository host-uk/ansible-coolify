---
- name: Prepare local environment
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Ensure ssh-agent is running
      ansible.builtin.shell: |
        if ! pgrep -u "{{ lookup('env', 'USER') }}" ssh-agent > /dev/null; then
          ssh-agent -s
        fi
      register: ssh_agent_setup
      changed_when: "'Agent pid' in ssh_agent_setup.stdout"

- name: Backup Coolify
  hosts: controller
  become: true
  become_user: root
  gather_facts: true
  tasks:
    - name: Perform Backup
      ansible.builtin.include_tasks:
        file: roles/coolify/tasks/backup.yml
      when: ansible_os_family == 'Debian'
