---
- name: Prepare Parallels VMs for development
  hosts: localhost
  connection: local
  gather_facts: false
  pre_tasks:
    - name: Ensure ssh-agent is running
      ansible.builtin.shell: |
        if ! pgrep -u "{{ lookup('env', 'USER') }}" ssh-agent > /dev/null; then
          ssh-agent -s
        fi
      register: ssh_agent_setup
      changed_when: "'Agent pid' in ssh_agent_setup.stdout"

  tasks:
    - name: Ensure Parallels VMs are ready
      ansible.builtin.include_role:
        name: parallels_vm
      vars:
        parallels_vm_name: "{{ item | replace('.lan', '') }}"
      loop: "{{ groups['development'] | select('search', 'vm-') | list }}"
      when: groups['development'] is defined
  tags:
    - parallels_vm

- name: Install Coolify on controller host
  hosts: controller
  become: true
  become_user: root
  gather_facts: true
  roles:
    - role: common
    - role: coolify

- name: Worker configuration
  hosts: worker
  become: true
  become_user: root
  gather_facts: true
  roles:
    - role: common
