---
- name: Update package lists
  ansible.builtin.apt:
    update_cache: true
  when: ansible_os_family == 'Debian'

- name: Upgrade all packages
  ansible.builtin.apt:
    upgrade: true
  when: ansible_os_family == 'Debian'

- name: Install public AuthorizedKeysFile
  ansible.posix.authorized_key:
    user: root
    state: present
    key: "{{ public_key }}"
  when: ansible_os_family == 'Debian'

- name: Install required packages
  ansible.builtin.package:
    name: 
      - ufw
      - fail2ban
    state: present
  when: ansible_os_family == 'Debian'

- name: Enable UFW
  community.general.ufw:
    state: enabled
    policy: allow
  when: ansible_os_family == 'Debian'


- name: Allow incoming traffic on specified ports
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
  loop:
    - 22
    - 80
    - 443
  when: ansible_os_family == 'Debian'

- name: Configure Fail2Ban
  ansible.builtin.template:
    src: jail.local.j2
    dest: /etc/fail2ban/jail.local
    mode: preserve
  when: ansible_os_family == 'Debian'

- name: Restart fail2ban
  ansible.builtin.service:
    name: fail2ban
    state: restarted
  when: ansible_os_family == 'Debian'

- name: Ensure no conflicting PermitRootLogin in sshd_config
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^PermitRootLogin'
    state: absent
  when: 
    - ansible_os_family == 'Debian'
    - ansible_connection != 'local'

- name: SSH Hardening for root user
  ansible.builtin.blockinfile:
    path: /etc/ssh/sshd_config
    block: |
      PermitRootLogin prohibit-password
      PasswordAuthentication no
      X11Forwarding no
      MaxAuthTries 2
      AllowTcpForwarding no
      AllowAgentForwarding no
      AuthorizedKeysFile .ssh/authorized_keys
  when: 
    - ansible_os_family == 'Debian'
    - ansible_connection != 'local'

- name: Restart sshd
  ansible.builtin.service:
    name: sshd
    state: restarted
  when: 
    - ansible_os_family == 'Debian'
    - ansible_connection != 'local'
