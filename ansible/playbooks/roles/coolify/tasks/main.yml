---
- name: Allow incoming UI Port
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
  loop:
    - 6001
    - 6002
    - 8000
  when: 
    - ansible_os_family == 'Debian'
    - common_manage_ufw | default(false) | bool

- name: Check if Coolify is already installed
  ansible.builtin.stat:
    path: /data/coolify/source/.env
  register: coolify_bin

- name: Validate Admin Password Strength
  ansible.builtin.assert:
    that:
      - coolify_root_user_password | length >= 8
      - coolify_root_user_password is search('[!@#$%^&*(),.?":{}|<>]')
    fail_msg: "Admin password must be at least 8 characters long and contain at least one special character."
  when: 
    - coolify_root_user_password != ""
    - not coolify_bin.stat.exists or coolify_api_token | default("") == ""

- name: Download Coolify installation script
  ansible.builtin.get_url:
    url: "https://cdn.coollabs.io/coolify/install.sh"
    dest: "/root/install.sh"
    mode: "0770"
  when: 
    - not coolify_bin.stat.exists
    - ansible_os_family == 'Debian'

- name: Execute Coolify installation script
  ansible.builtin.command: "/root/install.sh"
  environment:
    ROOT_USERNAME: "{{ coolify_root_username }}"
    ROOT_USER_EMAIL: "{{ coolify_root_user_email }}"
    ROOT_USER_PASSWORD: "{{ coolify_root_user_password }}"
    DOCKER_ADDRESS_POOL_BASE: "{{ coolify_docker_address_pool_base }}"
    DOCKER_ADDRESS_POOL_SIZE: "{{ coolify_docker_address_pool_size | string }}"
    DOCKER_POOL_FORCE_OVERRIDE: "{{ coolify_docker_pool_force_override | string | lower }}"
    AUTOUPDATE: "{{ coolify_autoupdate | string | lower }}"
    REGISTRY_URL: "{{ coolify_registry_url }}"
  register: install_result
  changed_when: "'Installation completed' in install_result.stdout"
  when: 
    - not coolify_bin.stat.exists
    - ansible_os_family == 'Debian'

- name: Debug installation script output
  ansible.builtin.debug:
    var: install_result.stdout_lines
  when: 
    - not coolify_bin.stat.exists
    - ansible_os_family == 'Debian'
    - install_result is defined

- name: Restart Coolify containers
  ansible.builtin.command: "docker compose restart"
  args:
    chdir: /data/coolify/source
  changed_when: true
  when: 
    - install_result is defined
    - install_result is changed
    - ansible_os_family == 'Debian'

- name: Ensure Coolify .env exists for backup
  ansible.builtin.stat:
    path: /data/coolify/source/.env
  register: coolify_env_file

- name: Backup Coolify .env file to local machine
  ansible.builtin.fetch:
    src: /data/coolify/source/.env
    dest: "{{ coolify_state_path }}/{{ inventory_hostname }}/backups/coolify/.env"
    flat: true
  when: 
    - ansible_os_family == 'Debian'
    - coolify_env_file.stat.exists

- name: Configure Coolify Application S3 Storage in .env
  ansible.builtin.lineinfile:
    path: /data/coolify/source/.env
    regexp: "^{{ item.key }}="
    line: "{{ item.key }}={{ item.value }}"
    state: present
  loop:
    - { key: 'S3_ENABLED', value: "{{ s3_enabled | string | lower }}" }
    - { key: 'S3_ENDPOINT', value: "{{ s3_endpoint }}" }
    - { key: 'S3_REGION', value: "{{ s3_region }}" }
    - { key: 'S3_BUCKET', value: "{{ s3_bucket }}" }
    - { key: 'S3_ACCESS_KEY', value: "{{ lookup('env', 'HETZNER_S3_APP_ACCESS_KEY') | default(s3_access_key) }}" }
    - { key: 'S3_SECRET_KEY', value: "{{ lookup('env', 'HETZNER_S3_APP_SECRET_KEY') | default(s3_secret_key) }}" }
  when: 
    - ansible_os_family == 'Debian'
    - coolify_env_file.stat.exists
    - s3_enabled | bool
  no_log: true
  notify: Restart Coolify containers

- name: Setup Coolify API
  ansible.builtin.include_tasks: api_setup.yml

- name: Setup Private Key
  ansible.builtin.include_tasks: key_setup.yml

- name: Register All Nodes
  ansible.builtin.include_tasks: register_all_nodes.yml
