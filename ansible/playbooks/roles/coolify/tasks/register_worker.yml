---
- name: Setup Coolify API and Token
  ansible.builtin.shell: |
    docker exec coolify php artisan tinker --execute='
    $s = \App\Models\InstanceSettings::get()->first();
    if ($s) {
        $s->is_api_enabled = true;
        $s->save();
    }
    $user = \App\Models\User::first();
    if ($user) {
        $team = $user->teams()->first();
        if ($team) {
            $tokenName = "ansible-token";
            $user->tokens()->where("name", $tokenName)->delete();
            $plainToken = \Illuminate\Support\Str::random(40);
            $token = new \Laravel\Sanctum\PersonalAccessToken();
            $token->name = $tokenName;
            $token->token = hash("sha256", $plainToken);
            $token->abilities = ["*"];
            $token->tokenable_id = $user->id;
            $token->tokenable_type = get_class($user);
            $token->team_id = $team->id;
            $token->save();
            echo $plainToken;
        }
    }
    '
  register: api_token_result
  changed_when: true
  no_log: true

- name: Set API Token fact
  ansible.builtin.set_fact:
    coolify_api_token: "{{ api_token_result.stdout | trim if api_token_result is not skipped and api_token_result.stdout is defined else 'dummy_token' }}"
  no_log: true

- name: Enable Coolify API via Endpoint
  ansible.builtin.uri:
    url: "http://localhost:8000/api/v1/enable"
    method: GET
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
    status_code: [200, 401]
  register: api_enable_result
  when: not ansible_check_mode

- name: Add Private Key to Coolify
  ansible.builtin.uri:
    url: "http://localhost:8000/api/v1/security/keys"
    method: POST
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "vm-worker-key"
      private_key: "{{ lookup('file', coolify_private_key_path) }}"
    status_code: [200, 201, 422]
  register: key_reg_result
  when: not ansible_check_mode

- name: Get Private Key UUID
  ansible.builtin.set_fact:
    coolify_key_uuid: "{{ key_reg_result.json.uuid if key_reg_result is not skipped and key_reg_result.status | default(0) in [200, 201] else '' }}"

- name: List Private Keys if not registered (find existing)
  ansible.builtin.uri:
    url: "http://localhost:8000/api/v1/security/keys"
    method: GET
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
  register: keys_list
  when: 
    - not ansible_check_mode
    - coolify_key_uuid == ""

- name: Find existing key UUID
  ansible.builtin.set_fact:
    coolify_key_uuid: "{{ (keys_list.json | selectattr('name', 'equalto', 'vm-worker-key') | first).uuid if keys_list is not skipped and keys_list.json is defined else coolify_key_uuid }}"
  when: 
    - not ansible_check_mode
    - coolify_key_uuid == ""

- name: Check if Worker Server is already registered
  ansible.builtin.uri:
    url: "http://localhost:8000/api/v1/servers"
    method: GET
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
  register: servers_list
  when: not ansible_check_mode

- name: Register Worker Server in Coolify
  ansible.builtin.uri:
    url: "http://localhost:8000/api/v1/servers"
    method: POST
    headers:
      Authorization: "Bearer {{ coolify_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ hostvars[coolify_worker_name]['ansible_hostname'] | default(coolify_worker_name) }}"
      description: "Registered via Ansible"
      ip: "{{ coolify_worker_ip }}"
      port: 22
      user: "root"
      private_key_uuid: "{{ coolify_key_uuid }}"
      is_build_server: false
      instant_validate: false
      proxy_type: "traefik"
    status_code: [200, 201]
  when: 
    - not ansible_check_mode
    - servers_list is not skipped
    - servers_list.json is defined
    - servers_list.json | selectattr('name', 'equalto', hostvars[coolify_worker_name]['ansible_hostname'] | default(coolify_worker_name)) | list | length == 0
