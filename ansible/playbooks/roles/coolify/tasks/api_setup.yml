---
- name: Check if API token is already saved on host
  ansible.builtin.stat:
    path: /data/coolify/ansible-token
  register: token_file_stat

- name: Read saved API token
  ansible.builtin.command: cat /data/coolify/ansible-token
  register: saved_token
  when: token_file_stat.stat.exists
  changed_when: false
  no_log: true

- name: Wait for Coolify container to be ready
  ansible.builtin.command: docker exec coolify php artisan --version
  register: artisan_check
  until: artisan_check.rc == 0
  retries: 30
  delay: 2
  changed_when: false

- name: Ensure Coolify API is enabled
  ansible.builtin.shell: |
    docker exec coolify php artisan tinker --execute='
    try {
        $settings = \App\Models\InstanceSettings::first();
        if ($settings) {
            if (!$settings->is_api_enabled) {
                $settings->is_api_enabled = true;
                $settings->save();
                echo "API_ENABLED";
            } else {
                echo "API_ALREADY_ENABLED";
            }
        } else {
            \App\Models\InstanceSettings::create(["is_api_enabled" => true]);
            echo "API_SETTINGS_CREATED";
        }
    } catch (\Exception $e) {
        echo "API_ENABLE_ERROR: " . $e->getMessage();
    }
    '
  register: api_enable_result
  changed_when: "'API_ENABLED' in api_enable_result.stdout or 'API_SETTINGS_CREATED' in api_enable_result.stdout"
  when: not ansible_check_mode
  no_log: true

- name: Setup Coolify API and Token
  ansible.builtin.shell: |
    docker exec coolify php artisan tinker --execute='
    $tokenName = "ansible-token";
    $user = \App\Models\User::first();
    
    if (!$user && "{{ coolify_root_user_email }}" != "") {
        $user = \App\Models\User::create([
            "name" => "{{ coolify_root_username }}",
            "email" => "{{ coolify_root_user_email }}",
            "password" => \Illuminate\Support\Facades\Hash::make("{{ coolify_root_user_password }}"),
            "email_verified_at" => now(),
        ]);
    }
    if ($user) {
        $token = $user->tokens()->where("name", $tokenName)->first();
        if ($token) {
            $token->delete();
        }
        $team = $user->teams()->first();
        if (!$team) {
            $team = \App\Models\Team::create([
                "name" => $user->name . " Team",
                "personal_team" => true,
            ]);
            $user->teams()->attach($team->id, ["role" => "admin"]);
        }
        if ($team) {
            $plainToken = \Illuminate\Support\Str::random(40);
            $newToken = new \Laravel\Sanctum\PersonalAccessToken();
            $newToken->name = $tokenName;
            $newToken->token = hash("sha256", $plainToken);
            $newToken->abilities = ["*"];
            $newToken->tokenable_id = $user->id;
            $newToken->tokenable_type = get_class($user);
            $newToken->team_id = $team->id;
            $newToken->save();
            echo $plainToken;
        }
    }
    '
  register: api_token_result
  when: not token_file_stat.stat.exists
  changed_when: true
  no_log: true

- name: Save API token to host for reuse
  ansible.builtin.copy:
    content: "{{ api_token_result.stdout_lines | last | trim }}"
    dest: /data/coolify/ansible-token
    mode: '0600'
  when: 
    - not token_file_stat.stat.exists 
    - api_token_result is defined
    - api_token_result.stdout_lines | default([]) | length > 0
  no_log: true

- name: Initialize API Token fact
  ansible.builtin.set_fact:
    coolify_api_token: ""

- name: Set API Token fact from saved file
  ansible.builtin.set_fact:
    coolify_api_token: "{{ saved_token.stdout_lines | last | trim }}"
  when: 
    - token_file_stat.stat.exists
    - saved_token.stdout_lines | default([]) | length > 0
  no_log: true

- name: Set API Token fact from command result
  ansible.builtin.set_fact:
    coolify_api_token: "{{ api_token_result.stdout_lines | last | trim }}"
  when: 
    - not token_file_stat.stat.exists
    - api_token_result is defined
    - api_token_result.stdout_lines | default([]) | length > 0
  no_log: true

- name: Validate API Token
  ansible.builtin.fail:
    msg: "Coolify API token is empty. This usually means the Coolify instance is not ready or no admin user exists yet."
  when: coolify_api_token == ""

